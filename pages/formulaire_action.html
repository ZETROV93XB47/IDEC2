<div class="page" data-name="my-actions-tab">
    <div class="navbar">
        <div class="navbar-bg"></div>
        <div class="navbar-inner sliding">
            <div class="left">
                <a href="#" class="link back">
                <i class="icon icon-back"></i>
                <span class="if-not-md">Back</span>
                </a>
            </div>
            <div class="title">OSIRI - Mes actions</div>
			<div class="right">
				<a id="upload_action" href="#" class="link icon-only"><i class="fa fa-paper-plane" style="font-size:20px;"></i></a>
			</div>
        </div>
    </div>
    <style>
        li{
            margin-top: 20px;
        }
    </style>
    <div class="page-content">
        
        <script id="osiri_rex_form_template" type="text/template7">
            <div class="popover popover-action-photo">
                <div class="popover-inner">
                    <div class="list">
                        <ul>
                            <li><a class="list-button popover-close item-link osiri_rex_take_photo" href="#">Prendre une photo</a></li>
                            <li><a class="list-button popover-close item-link osiri_rex_add_photo" href="#">Galerie du téléphone</a></li>
                        </ul>
                    </div>
                </div>
            </div>
            <div class="card">
				<div class="card-content card-content-padding" id="op2a_materiel_infos">
					<div class="list">
						<ul>
						    <li>
						        <div class="item-content">
                                    <div class="item-inner">
                                        <div class="item-title">Pilote : Pierre</div>
                                        <div class="item-after">
                                            <label osiri_type="Pilote" class="checkbox" style="padding-top: 4px;">
                                                <input class="name_change" type="checkbox"><i class="icon-checkbox"></i>
                                            </label>
                                        </div>
                                    </div>
						        </div>
						    </li>
						    <li>
                                <div class="item-content">
                                    <div class="item-inner">
                                    <div class="item-title">Contact chantier : Jéremy</div>
                                        <div class="item-after">
                                            <label osiri_type="Contact chantier" class="checkbox" style="padding-top: 4px;">
                                                <input class="name_change" type="checkbox"><i class="icon-checkbox"></i>
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </li>
						</ul>
					</div>
				</div>
			</div>
            <div class="list inset">
                <ul>
                    <li id="ergonomie">
                        <div class="item-content item-input">
                            <div class="item-inner item-title" style="white-space: normal; font-weight: bold"><div>Ergonomie <span style="color:red;">*</span></div></div>
                            <div class="item-after">
                                <!-- <p class="segmented segmented-raised segmented-round">
                                    <button class="button button-round {{#if ergonomie}}{{#js_if "this.ergonomie.action === 'p'"}}button-active{{/js_if}}{{/if}}" value="p">Positif</button>
                                    <button class="button button-round {{#if ergonomie}}{{#js_if "this.ergonomie.action === 'n'"}}button-active{{/js_if}}{{/if}}" value="n">Négatif</button>
                                </p> -->
                            </div>
                        </div>
                        <div class="osiri_action_option">
                            <div class="stars row" style="margin-left: 10%; margin-right: 10%;">
                                <a class="star item-link"><i class="col fal fa-star"></i></a>
                                <a class="star item-link"><i class="col fal fa-star"></i></a>
                                <a class="star item-link"><i class="col fal fa-star"></i></a>
                                <a class="star item-link"><i class="col fal fa-star"></i></a>
                                <a class="star item-link"><i class="col fal fa-star"></i></a>
                            </div>
                            <div class="item-content item-input">
                                <div class="item-inner" style="display: none; padding-top: 24px;">
                                    <div class="item-input-wrap" style="margin-bottom: 30px;">
                                        <div class="item-subtitle"><div>Commentaire <span style="color:red;">*</span></div></div>
                                        <textarea class="resizable" osiri_validation="not_empty minlength 15" style="height: 70px;" placeholder="Commentaire" osiri_content="commentaire">{{#if ergonomie}}{{ ergonomie.commentaire }}{{/if}}</textarea>
                                    </div>
                                    <div class="item-input-wrap">
                                        <div class="item-subtitle"><div>Proposition <span style="color:red;">*</span></div></div>
                                        <textarea class="resizable" osiri_validation="not_empty" style="height: 70px;" placeholder="Modification proposée" osiri_content="proposition">{{#if ergonomie}}{{ ergonomie.proposition }}{{/if}}</textarea>
                                    </div>
                                </div>
                                <div class="item-media" style="padding: 0; height: 180px; display: none;">
                                    <div style="height: 65px;">
                                        <a class="link popover-open add_photo" osiri_prop="ergonomie" href="#" data-popover=".popover-action-photo" style="width: 40px; height: 40px; padding-left: 17px;">
                                            <i class="f7-icon material-icons md-only">add_a_photo</i>
                                        </a>
                                    </div>
                                </div>
                            </div>
                            <div id="osiri_rex_photos_ergonomie" class="actions-grid modal-in" style="display:{{#if ergonomie}}block{{else}}none{{/if}};">
                                <div class="actions-group">
                                    {{#if ergonomie}}{{#if ergonomie.image}}
                                    <div class="actions-button">
                                        <div class="actions-button-media"><img src="data:application/octet-stream;base64,{{ ergonomie.image }}" width="48"></div>
                                        <div class="actions-button-text dynamic-popover">image</div>
                                    </div>
                                    {{/if}}{{/if}}
                                </div>
                            </div>
                        </div>
                    </li>
                    <li id="securite">
                        <div class="item-content item-input">
                            <div class="item-inner item-title" style="white-space: normal; font-weight: bold"><div>Sécurité <span style="color:red;">*</span></div></div>
                            <div class="item-after">
                                <!-- <p class="segmented segmented-raised segmented-round">
                                    <button class="button button-round {{#if securite}}{{#js_if "this.securite.action === 'p'"}}button-active{{/js_if}}{{/if}}" value="p">Positif</button>
                                    <button class="button button-round {{#if securite}}{{#js_if "this.securite.action === 'n'"}}button-active{{/js_if}}{{/if}}" value="n">Négatif</button>
                                </p> -->
                            </div>
                        </div>
                        <div class="osiri_action_option">
                            <div class="stars row" style="margin-left: 10%; margin-right: 10%;">
                                <a class="star item-link"><i class="col fal fa-star"></i></a>
                                <a class="star item-link"><i class="col fal fa-star"></i></a>
                                <a class="star item-link"><i class="col fal fa-star"></i></a>
                                <a class="star item-link"><i class="col fal fa-star"></i></a>
                                <a class="star item-link"><i class="col fal fa-star"></i></a>
                            </div>
                            <div class="item-content item-input">
                                <div class="item-inner" style="display: none; padding-top: 24px;">
                                    <div class="item-input-wrap" style="margin-bottom: 30px;">
                                        <div class="item-subtitle"><div>Commentaire <span style="color:red;">*</span></div></div>
                                        <textarea class="resizable" osiri_validation="not_empty minlength 15" style="height: 70px;" placeholder="Commentaire" osiri_content="commentaire">{{#if securite}}{{ securite.commentaire }}{{/if}}</textarea>
                                    </div>
                                    <div class="item-input-wrap">
                                        <div class="item-subtitle"><div>Proposition <span style="color:red;">*</span></div></div>
                                        <textarea class="resizable" osiri_validation="not_empty" style="height: 70px;" placeholder="Modification proposée" osiri_content="proposition">{{#if securite}}{{ securite.proposition }}{{/if}}</textarea>
                                    </div>
                                </div>
                                <div class="item-media" style="padding: 0; height: 180px; display: none;">
                                    <div style="height: 65px;">
                                        <a class="link popover-open add_photo" osiri_prop="securite" href="#" data-popover=".popover-action-photo" style="width: 40px; height: 40px; padding-left: 17px;">
                                            <i class="f7-icon material-icons md-only">add_a_photo</i>
                                        </a>
                                    </div>
                                </div>
                            </div>
                            <div id="osiri_rex_photos_securite" class="actions-grid modal-in" style="display:{{#if securite}}block{{else}}none{{/if}};">
                                <div class="actions-group">
                                    {{#if securite}}{{#if securite.image}}
                                    <div class="actions-button">
                                        <div class="actions-button-media"><img src="data:application/octet-stream;base64,{{ securite.image }}" width="48"></div>
                                        <div class="actions-button-text dynamic-popover">image</div>
                                    </div>
                                    {{/if}}{{/if}}
                                </div>
                            </div>
                        </div>
                    </li>
                    <li id="productivite">
                        <div class="item-content item-input">
                            <div class="item-inner item-title" style="white-space: normal; font-weight: bold">Productivité</div>
                            <div class="item-after">
                                <!-- <p class="segmented segmented-raised segmented-round">
                                    <button class="button button-round {{#if productivite}}{{#js_if "this.productivite.action === 'p'"}}button-active{{/js_if}}{{/if}}" value="p">Positif</button>
                                    <button class="button button-round {{#if productivite}}{{#js_if "this.productivite.action === 'n'"}}button-active{{/js_if}}{{/if}}" value="n">Négatif</button>
                                </p> -->
                            </div>
                        </div>
                        <div class="osiri_action_option">
                            <div class="stars row" style="margin-left: 10%; margin-right: 10%;">
                                <a class="star item-link"><i class="col fal fa-star"></i></a>
                                <a class="star item-link"><i class="col fal fa-star"></i></a>
                                <a class="star item-link"><i class="col fal fa-star"></i></a>
                                <a class="star item-link"><i class="col fal fa-star"></i></a>
                                <a class="star item-link"><i class="col fal fa-star"></i></a>
                            </div>
                            <div class="item-content item-input">
                                <div class="item-inner" style="display: none; padding-top: 24px;">
                                    <div class="item-input-wrap" style="margin-bottom: 30px;">
                                        <div class="item-subtitle">Commentaire</div>
                                        <textarea class="resizable" style="height: 70px;" placeholder="Commentaire" osiri_content="commentaire">{{#if productivite}}{{ productivite.commentaire }}{{/if}}</textarea>
                                    </div>
                                    <div class="item-input-wrap">
                                        <div class="item-subtitle">Proposition</div>
                                        <textarea class="resizable" style="height: 70px;" placeholder="Modification proposée" osiri_content="proposition">{{#if productivite}}{{ productivite.proposition }}{{/if}}</textarea>
                                    </div>
                                </div>
                                <div class="item-media" style="padding: 0; height: 180px; display: none;">
                                    <div style="height: 65px;">
                                        <a class="link popover-open add_photo" osiri_prop="productivite" href="#" data-popover=".popover-action-photo" style="width: 40px; height: 40px; padding-left: 17px;">
                                            <i class="f7-icon material-icons md-only">add_a_photo</i>
                                        </a>
                                    </div>
                                </div>
                            </div>
                            <div id="osiri_rex_photos_productivite" class="actions-grid modal-in" style="display:{{#if productivite}}block{{else}}none{{/if}};">
                                <div class="actions-group">
                                    {{#if productivite}}{{#if productivite.image}}
                                    <div class="actions-button">
                                        <div class="actions-button-media"><img src="data:application/octet-stream;base64,{{ productivite.image }}" width="48"></div>
                                        <div class="actions-button-text dynamic-popover">image</div>
                                    </div>
                                    {{/if}}{{/if}}
                                </div>
                            </div>
                        </div>
                    </li>
                    <li id="competitivite">
                        <div class="item-content item-input">
                            <div class="item-inner item-title" style="white-space: normal; font-weight: bold">Compétitivité</div>
                            <div class="item-after">
                                <!-- <p class="segmented segmented-raised segmented-round">
                                    <button class="button button-round {{#if competitivite}}{{#js_if "this.competitivite.action === 'p'"}}button-active{{/js_if}}{{/if}}" value="p">Positif</button>
                                    <button class="button button-round {{#if competitivite}}{{#js_if "this.competitivite.action === 'n'"}}button-active{{/js_if}}{{/if}}" value="n">Négatif</button>
                                </p> -->
                            </div>
                        </div>
                        <div class="osiri_action_option">
                            <div class="stars row" style="margin-left: 10%; margin-right: 10%;">
                                <a class="star item-link"><i class="col fal fa-star"></i></a>
                                <a class="star item-link"><i class="col fal fa-star"></i></a>
                                <a class="star item-link"><i class="col fal fa-star"></i></a>
                                <a class="star item-link"><i class="col fal fa-star"></i></a>
                                <a class="star item-link"><i class="col fal fa-star"></i></a>
                            </div>
                            <div class="item-content item-input">
                                <div class="item-inner" style="display: none; padding-top: 24px;">
                                    <div class="item-input-wrap" style="margin-bottom: 30px;">
                                        <div class="item-subtitle">Commentaire</div>
                                        <textarea class="resizable" style="height: 70px;" placeholder="Commentaire" osiri_content="commentaire">{{#if competitivite}}{{ competitivite.commentaire }}{{/if}}</textarea>
                                    </div>
                                    <div class="item-input-wrap">
                                        <div class="item-subtitle">Proposition</div>
                                        <textarea class="resizable" style="height: 70px;" placeholder="Modification proposée" osiri_content="proposition">{{#if competitivite}}{{ competitivite.proposition }}{{/if}}</textarea>
                                    </div>
                                </div>
                                <div class="item-media" style="padding: 0; height: 180px; display: none;">
                                    <div style="height: 65px;">
                                        <a class="link popover-open add_photo" osiri_prop="competitivite" href="#" data-popover=".popover-action-photo" style="width: 40px; height: 40px; padding-left: 17px;">
                                            <i class="f7-icon material-icons md-only">add_a_photo</i>
                                        </a>
                                    </div>
                                </div>
                            </div>
                            <div id="osiri_rex_photos_competitivite" class="actions-grid modal-in" style="display:{{#if competitivite}}block{{else}}none{{/if}};">
                                <div class="actions-group">
                                    {{#if competitivite}}{{#if competitivite.image}}
                                    <div class="actions-button">
                                        <div class="actions-button-media"><img src="data:application/octet-stream;base64,{{ competitivite.image }}" width="48"></div>
                                        <div class="actions-button-text dynamic-popover">image</div>
                                    </div>
                                    {{/if}}{{/if}}
                                </div>
                            </div>
                        </div>
                    </li>
                    <li id="environnement">
                        <div class="item-content item-input">
                            <div class="item-inner item-title" style="white-space: normal; font-weight: bold">Environnement</div>
                            <div class="item-after">
                                <!-- <p class="segmented segmented-raised segmented-round">
                                    <button class="button button-round {{#if environnement}}{{#js_if "this.environnement.action === 'p'"}}button-active{{/js_if}}{{/if}}" value="p">Positif</button>
                                    <button class="button button-round {{#if environnement}}{{#js_if "this.environnement.action === 'n'"}}button-active{{/js_if}}{{/if}}" value="n">Négatif</button>
                                </p> -->
                            </div>
                        </div>
                        <div class="osiri_action_option">
                            <div class="stars row" style="margin-left: 10%; margin-right: 10%;">
                                <a class="star item-link"><i class="col fal fa-star"></i></a>
                                <a class="star item-link"><i class="col fal fa-star"></i></a>
                                <a class="star item-link"><i class="col fal fa-star"></i></a>
                                <a class="star item-link"><i class="col fal fa-star"></i></a>
                                <a class="star item-link"><i class="col fal fa-star"></i></a>
                            </div>
                            <div class="item-content item-input">
                                <div class="item-inner" style="display: none; padding-top: 24px;">
                                    <div class="item-input-wrap" style="margin-bottom: 30px;">
                                        <div class="item-subtitle">Commentaire</div>
                                        <textarea class="resizable" style="height: 70px;" placeholder="Commentaire" osiri_content="commentaire">{{#if environnement}}{{ environnement.commentaire }}{{/if}}</textarea>
                                    </div>
                                    <div class="item-input-wrap">
                                        <div class="item-subtitle">Proposition</div>
                                        <textarea class="resizable" style="height: 70px;" placeholder="Modification proposée" osiri_content="proposition">{{#if environnement}}{{ environnement.proposition }}{{/if}}</textarea>
                                    </div>
                                </div>
                                <div class="item-media" style="padding: 0; height: 180px; display: none;">
                                    <div style="height: 65px;">
                                        <a class="link popover-open add_photo" osiri_prop="environnement" href="#" data-popover=".popover-action-photo" style="width: 40px; height: 40px; padding-left: 17px;">
                                            <i class="f7-icon material-icons md-only">add_a_photo</i>
                                        </a>
                                    </div>
                                </div>
                            </div>
                            <div id="osiri_rex_photos_environnement" class="actions-grid modal-in" style="display:{{#if environnement}}block{{else}}none{{/if}};">
                                <div class="actions-group">
                                    {{#if environnement}}{{#if environnement.image}}
                                    <div class="actions-button">
                                        <div class="actions-button-media"><img src="data:application/octet-stream;base64,{{ environnement.image }}" width="48"></div>
                                        <div class="actions-button-text dynamic-popover">image</div>
                                    </div>
                                    {{/if}}{{/if}}
                                </div>
                            </div>
                        </div>
                    </li>
                    <li id="autre">
                        <div class="item-content item-input">
                            <div class="item-inner item-title" style="white-space: normal; font-weight: bold">Autre</div>
                            <div class="item-after">
                                <!-- <p class="segmented segmented-raised segmented-round">
                                    <button class="button button-round {{#if autre}}{{#js_if "this.autre.action === 'p'"}}button-active{{/js_if}}{{/if}}" value="p">Positif</button>
                                    <button class="button button-round {{#if autre}}{{#js_if "this.autre.action === 'n'"}}button-active{{/js_if}}{{/if}}" value="n">Négatif</button>
                                </p> -->
                            </div>
                        </div>
                        <div class="osiri_action_option">
                            <div class="stars row" style="margin-left: 10%; margin-right: 10%;">
                                <a class="star item-link"><i class="col fal fa-star"></i></a>
                                <a class="star item-link"><i class="col fal fa-star"></i></a>
                                <a class="star item-link"><i class="col fal fa-star"></i></a>
                                <a class="star item-link"><i class="col fal fa-star"></i></a>
                                <a class="star item-link"><i class="col fal fa-star"></i></a>
                            </div>
                            <div class="item-content item-input">
                                <div class="item-inner" style="display: none; padding-top: 24px;">
                                    <div class="item-input-wrap" style="margin-bottom: 30px;">
                                        <div class="item-subtitle">Commentaire</div>
                                        <textarea class="resizable" style="height: 70px;" placeholder="Commentaire" osiri_content="commentaire">{{#if autre}}{{ autre.commentaire }}{{/if}}</textarea>
                                    </div>
                                    <div class="item-input-wrap">
                                        <div class="item-subtitle">Proposition</div>
                                        <textarea class="resizable" style="height: 70px;" placeholder="Modification proposée" osiri_content="proposition">{{#if autre}}{{ autre.proposition }}{{/if}}</textarea>
                                    </div>
                                </div>
                                <div class="item-media" style="padding: 0; height: 180px; display: none;">
                                    <div style="height: 65px;">
                                        <a class="link popover-open add_photo" osiri_prop="autre" href="#" data-popover=".popover-action-photo" style="width: 40px; height: 40px; padding-left: 17px;">
                                            <i class="f7-icon material-icons md-only">add_a_photo</i>
                                        </a>
                                    </div>
                                </div>
                            </div>
                            <div id="osiri_rex_photos_autre" class="actions-grid modal-in" style="display:{{#if autre}}block{{else}}none{{/if}};">
                                <div class="actions-group">
                                    {{#if autre}}{{#if autre.image}}
                                    <div class="actions-button">
                                        <div class="actions-button-media"><img src="data:application/octet-stream;base64,{{ autre.image }}" width="48"></div>
                                        <div class="actions-button-text dynamic-popover">image</div>
                                    </div>
                                    {{/if}}{{/if}}
                                </div>
                            </div>
                        </div>
                    </li>
                    <li id="globale">
                        <div class="item-content item-input">
                            <div class="item-inner item-title" style="white-space: normal; font-weight: bold">Globale</div>
                            <div class="item-after">
                                <!-- <p class="segmented segmented-raised segmented-round">
                                    <button class="button button-round {{#if globale}}{{#js_if "this.globale.action === 'p'"}}button-active{{/js_if}}{{/if}}" value="p">Positif</button>
                                    <button class="button button-round {{#if globale}}{{#js_if "this.globale.action === 'n'"}}button-active{{/js_if}}{{/if}}" value="n">Négatif</button>
                                </p> -->
                            </div>
                        </div>
                        <div class="osiri_action_option">
                            <div class="stars row" style="margin-left: 10%; margin-right: 10%;">
                                <a class="star item-link"><i class="col fal fa-star"></i></a>
                                <a class="star item-link"><i class="col fal fa-star"></i></a>
                                <a class="star item-link"><i class="col fal fa-star"></i></a>
                                <a class="star item-link"><i class="col fal fa-star"></i></a>
                                <a class="star item-link"><i class="col fal fa-star"></i></a>
                            </div>
                            <div class="item-content item-input">
                                <div class="item-inner" style="display: none; padding-top: 24px;">
                                    <div class="item-input-wrap" style="margin-bottom: 30px;">
                                        <div class="item-subtitle">Commentaire</div>
                                        <textarea class="resizable" style="height: 70px;" placeholder="Commentaire" osiri_content="commentaire">{{#if globale}}{{ globale.commentaire }}{{/if}}</textarea>
                                    </div>
                                    <div class="item-input-wrap">
                                        <div class="item-subtitle">Proposition</div>
                                        <textarea class="resizable" style="height: 70px;" placeholder="Modification proposée" osiri_content="proposition">{{#if globale}}{{ globale.proposition }}{{/if}}</textarea>
                                    </div>
                                </div>
                                <div class="item-media" style="padding: 0; height: 180px; display: none;">
                                    <div style="height: 65px;">
                                        <a class="link popover-open add_photo" osiri_prop="globale" href="#" data-popover=".popover-action-photo" style="width: 40px; height: 40px; padding-left: 17px;">
                                            <i class="f7-icon material-icons md-only">add_a_photo</i>
                                        </a>
                                    </div>
                                </div>
                            </div>
                            <div id="osiri_rex_photos_globale" class="actions-grid modal-in" style="display:{{#if globale}}block{{else}}none{{/if}};">
                                <div class="actions-group">
                                    {{#if globale}}{{#if globale.image}}
                                    <div class="actions-button">
                                        <div class="actions-button-media"><img src="data:application/octet-stream;base64,{{ globale.image }}" width="48"></div>
                                        <div class="actions-button-text dynamic-popover">image</div>
                                    </div>
                                    {{/if}}{{/if}}
                                </div>
                            </div>
                        </div>
                    </li>
                    <li id="complement_infos">
                        <div class="item-content item-input">
                            <div class="item-inner item-title" style="white-space: normal; font-weight: bold">Complément d'information</div>
                            <div class="item-after">
                                
                            </div>
                        </div>
                        <div class="osiri_action_option">
                            <div class="item-content item-input">
                                <div class="item-inner">
                                    <div class="item-input-wrap" style="margin-bottom: 30px;">
                                        <textarea class="resizable" style="height: 70px;" placeholder="Commentaire" osiri_content="commentaire"></textarea>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </li>
                </ul>
            </div>
        </script>

        <script id="osiri_rex_preform_template" type="text/template7">
            <div class="block">
                <div class="row">
                    <a class="col button" id="recived" href="#">Matériel reçu</a>
                    <a class="col button" id="not_recived" href="#">Matériel non reçu</a>
                </div>
            </div>
        </script>
        
		<div id="osiri_rex_content"></div>
    </div>
    <script type="text/javascript" ws_script="page">
        ws_engine.register_page("my-actions-tab", ws_page.extend(
        {
            custom_init: function(page, event, params)
            {
                var self = this;

			    self.action_id = self.params.action_id;
			    self.chantier_id = self.params.chantier_id;
			    self.projet_id = self.params.projet_id;

                self.data = {};
                self.template_data = {};
                self.template_data.imgs = [];
                
                function init_context()
                {
                    var condition = OSIRI_REX_PROPERTY_CHANTIER_ID+" = ? AND "+ OSIRI_REX_PROPERTY_PROJET_ID+" = ?";
                    var binding = [self.chantier_id, self.projet_id];

                    return ws_database.rexs.get(condition, binding).then(function(result)
                    {
                        debugger
                        self.is_new = (result == null);
                        if (!self.is_new) 
                        {
                            self.rexs = result;
                            self.rex_id = result.id;
                            self.data = JSON.parse(result.data);
                        }
                        else return self.add_rex().then(function(id)
                        {
                            var condition = OSIRI_REX_PROPERTY_ID + " = ?";
                            var binding = [id];

                            return ws_database.rexs.get(condition, binding).then(function(result)
                            {
                                self.rex_id = result.id;
                                self.rexs = result;
                            });
                        });
                    })
                    .catch(function(error)
                    {
                        if (ws_defines.debug) console.log(error);
                        app.dialog.alert(error);
                    });
                }

                init_context().then(function()
                {
                    return self.load_page();
                })
                .catch(function(error)
                {
                    if (ws_defines.debug) console.log(error);
                    app.dialog.alert(error);
                });
            },

            init_data: function()
            {
                var properties = Object.keys(this.data);
            },
            
            load_page: function()
            {
                var self = this;
                var prop;

                self.template_data = self.data;
                if (self.rexs[OSIRI_REX_PROPERTY_MATERIEL_RECEIVED] == "false")
                return self.apply_template(page, "osiri_rex_preform_template", "osiri_rex_content", self.template_data).then(function()
                {
                    $("#recived").click(function()
                    {
                        ws_database.rexs.set_with_id(self.rex_id, [OSIRI_REX_PROPERTY_MATERIEL_RECEIVED], [true]).then(function()
                        {
                            self.rexs[OSIRI_REX_PROPERTY_MATERIEL_RECEIVED] = true;
                            return self.load_page();
                        });
                    });

                    $("#not_recived").click(function()
                    {
                        ws_tools.toast("Email envoyé au pilote ...");
                        return ws_server.send_to_pilote();
                    });
                });
                
                return self.apply_template(page, "osiri_rex_form_template", "osiri_rex_content", self.template_data).then(function()
				{
                    var properties = Object.keys(self.data);
                    var color = 'yellow';
                    var half_icon = 'col fas fa-star-half-alt';

                    for (var i = 0; i<properties.length; i++)
                    {
                        var stars = $('#'+ properties[i]).find('.stars');
                        var stars_nbr = self.data[properties[i]].action;
                        var icon = 'col fas fa-star';
                        debugger
                        if (stars_nbr)
                        {
                            stars.next().find('.item-inner').css('display', 'block');
                            stars.next().find('.item-media').css('display', 'block');
                            stars.next().next().css('display', 'block');

                            if (stars_nbr == Math.trunc(stars_nbr))
                            {
                                var stars_elements = $('#'+ properties[i]).find('.stars').children();
                                
                                for ( var j = 0 ; j<stars_nbr; j++)
                                {
                                    $(stars_elements[j]).find('i').removeClass();
                                    $(stars_elements[j]).find('i').addClass(icon);
                                    $(stars_elements[j]).css('color', color);
                                }
                            }
                            else
                            {
                                debugger
                                stars_nbr = Math.ceil(stars_nbr);

                                var stars_elements = $('#'+ properties[i]).find('.stars').children();
                                
                                for ( var j = 0 ; j<stars_nbr; j++)
                                {
                                    if (j == stars_nbr-1)
                                    {
                                        icon = half_icon;
                                    }

                                    $(stars_elements[j]).find('i').removeClass();
                                    $(stars_elements[j]).find('i').addClass(icon);
                                    $(stars_elements[j]).css('color', color);
                                }
                            }
                            
                        }
                        else
                        {
                            stars.next().next().css('display', 'none');
                        }
                    }
                    
                    var option_element = $("#osiri_rex_content");
                    $$('.add_photo').on('click', function (e)
                    {
                        prop = $(this).attr('osiri_prop');
                    });

					// affectation d'une nouvelle image
					option_element.find(".osiri_rex_take_photo").click(function()
					{
						osiri_photos.take_photo(Camera.PictureSourceType.CAMERA).then(function(base64)
						{
							option_element.find("#osiri_rex_photos_"+ prop)[0].style.display = "block";
                            $('#osiri_rex_photos_'+ prop +' div.actions-group').append('<div class="actions-button"><div class="actions-button-media"><img src="data:application/octet-stream;base64,'+ base64 +'" width="48"></div><div class="actions-button-text dynamic-popover">image</div></div>');
							self.set_value(prop, base64, OSIRI_NOUVELLE_IDEE_OPTION_KEY_IMAGE);
						});
                    });
                    
					// affectation d'une image deja stocker dans la galerie du telephone
					option_element.find(".osiri_rex_add_photo").click(function(e)
					{
						osiri_photos.take_photo(Camera.PictureSourceType.PHOTOLIBRARY).then(function(base64)
						{
                            option_element.find("#osiri_rex_photos_"+ prop)[0].style.display = "block";
                            $('#osiri_rex_photos_'+ prop +' div.actions-group').append('<div class="actions-button"><div class="actions-button-media"><img src="data:application/octet-stream;base64,'+ base64 +'" width="48"></div><div class="actions-button-text dynamic-popover">image</div></div>');
							self.set_value(prop, base64, OSIRI_NOUVELLE_IDEE_OPTION_KEY_IMAGE);
						});
                    });
                    
                    $("#osiri_rex_content textarea").change(function()
					{   
                        var id = $(this).parent().parent().parent().parent().parent().attr('id');
                        var content = $(this).attr('osiri_content');
                        
						self.set_value(id, $$(this).val(), content);
                    });
                    
                    $('.list li .item-content button').click(function(e)
                    {
                        var id = $$(this).parent().parent().parent().parent().attr("id");
                        var buttons = $$(this).parent().find(".button");
                        var value = $$(this).val();

                        buttons.removeClass("button-active");
                        $$(this).parent().find(".button[value='"+ value +"']").addClass("button-active");

						self.set_value(id, value, OSIRI_NOUVELLE_IDEE_OPTION_KEY_ACTION);
                    });

                    $('.star').click(function()
                    {
                        var stars = $(this).parent();
                        stars.next().find('.item-inner').css('display', 'block');
                        stars.next().find('.item-media').css('display', 'block');
                        stars.next().next().css('display', 'block');

                        var id = stars.parent().parent().attr("id");
                        var index = $(this).index();
                        var stars_elemnts = stars.children();
                        var color = 'yellow';
                        var origin_icon = 'col fal fa-star';
                        var icon = 'col fas fa-star';
                        var half_icon = 'col fas fa-star-half-alt';

                        if (self.data[id] == undefined) self.data[id] = {};

                        if (Math.ceil(self.data[id][OSIRI_NOUVELLE_IDEE_OPTION_KEY_ACTION]) == index+1)
                        {
                            if ($(this).find('i').attr('class') == 'col fas fa-star-half-alt' && index == 0)
                            {
                                debugger
                                var value = self.update_stars(index, stars_elemnts, origin_icon, "", 0);
                                
                                stars.next().find('.item-inner').css('display', 'none');
                                stars.next().find('.item-media').css('display', 'none');
                                stars.next().next().css('display', 'none');
                            }
                            else if ($(this).find('i').attr('class') == 'col fas fa-star-half-alt')
                            {
                                debugger
                                var value = self.update_stars(index, stars_elemnts, icon, color, 1);
                            }
                            else
                            {
                                var value = self.update_stars(index, stars_elemnts, half_icon, color, 0.5);
                            }
                            
                        }
                        else
                        {
                            for (var i = 0; i<stars_elemnts.length; i++)
                            {
                                $(stars_elemnts[i]).find('i').removeClass();
                                $(stars_elemnts[i]).find('i').addClass(icon);
                                $(stars_elemnts[i]).css('color', color);

                                if( i == index)
                                {
                                    color = '';
                                    icon = origin_icon;
                                    var value = i+1;
                                }
                            }
                        }
                        
						self.set_value(id, value, OSIRI_NOUVELLE_IDEE_OPTION_KEY_ACTION);
                    });

                    $('textarea').on('input', function()
                    {
                        self.validation_required(this);
                    });

                    $('textarea').focus(function()
                    {
                        self.validation_required(this);
                    });

                    $("#upload_action").click(function()
                    {
                        self.upload();
                    });

                    $('input.name_change').click(function()
                    {
                        var self = this;

                        if ($(this)[0].checked) 
                        {
                            var type = $(self).parent().attr('osiri_type');
                            var name = $(self).parent().parent().parent().find('.item-title').text().split(':')[1];
                            app.dialog.create({
                                title: app.name,
                                text: 'Veuillez confirmer le nom du '+ type,
                                cssClass: 'custom-dialog',
                                closeByBackdropClick: 'true',
                                content: '<div class="dialog-input-field input"><input type="text" class="dialog-input" value="'+name+'"></div>',
                                buttons: [
                                    {
                                        text: 'OK',
                                        onClick: function () {
                                            
                                            var name = $('.dialog-input-field.input input').val();
                                            var text = $(self).parent().parent().parent().find('.item-title').text(type+' : '+name);
                                        },
                                    },
                                ],
                            }).open();

                            // app.dialog.confirm('Est ce que c\'est la bonne personne ?', function ()
                            // {
                            //     app.dialog.alert('Super !');
                            // },
                            // function()
                            // {
                            //     app.dialog.prompt('Veuillez saisir son nom et prènom', function (name)
                            //     {
                            //         var type = $(self).parent().attr('osiri_type');
                            //         var text = $(self).parent().parent().parent().find('.item-title').text(type+' : '+name);
                            //     });
                            // });
                        }
                    });

                    
                });
            },

            validation_required: function(self)
            {
                var conditions = $(self).attr('osiri_validation');
                var text = $(self).val();
                if (conditions) 
                {
                    var conditions_array = conditions.split(' ');
                    for (var i = 0;i<conditions_array.length; i++)
                    {
                        switch(conditions_array[i])
                        {
                            case 'not_empty':
                                var message = 'Veuillez renseigner ce champ';
                                if (text.length == 0)
                                {
                                    if ($(self).parent().children().length <= 2) 
                                    {
                                        var message_error = '<div class="item-input-error-message" style="display: block;">'+message+'</div>';
                                        $(self).parent().append(message_error);
                                    }
                                    else
                                    {
                                        $(self).parent().find(".item-input-error-message").text(message);
                                        $($(self).parent().find(".item-input-error-message")[0]).css('display', 'block');
                                    }
                                }
                                else $($(self).parent().find(".item-input-error-message")[0]).css('display', 'none');
                                break;
                            case 'minlength':
                                i++;
                                var minlength = parseInt(conditions_array[i]);
                                var message = 'Veuillez saisir plus de '+ conditions_array[i] +' caractères';
                                if (text.length <= minlength)
                                {
                                    if ($(self).parent().children().length <= 2) 
                                    {
                                        var message_error = '<div class="item-input-error-message" style="display: block;">'+ message +'</div>';
                                        // $(this).parent().css('background', 'var(--f7-input-invalid-border-color,var(--f7-input-error-text-color))');
                                        $(self).parent().append(message_error);
                                    }
                                    else
                                    {
                                        $(self).parent().find(".item-input-error-message").text(message);
                                        $($(self).parent().find(".item-input-error-message")[0]).css('display', 'block');
                                    }
                                }
                                else
                                {
                                    $($(self).parent().find(".item-input-error-message")[0]).css('display', 'none');
                                }
                                break;
                        }
                    }
                }
            },

            upload: function()
			{
				var self = this;

				app.dialog.preloader("Envoi en cours...");
				debugger
                if (self.data.ergonomie == undefined)
                {
                    app.dialog.close();
                    app.dialog.alert("Veuillez renseigner les champs de l'ergonomie !");
                    return true;
                }

                if (self.data.securite == undefined)
                {
                    app.dialog.close();
                    app.dialog.alert("Veuillez renseigner les champs de sécurite !");
                    return true;
                }

                app.dialog.close();
				app.dialog.alert("La nouvelle idée a bien été envoyée à OSIRI");
                return true;
                debugger
				ws_server.depose_idee(self.data).then(function(result)
				{
					debugger
					if (typeof result == 'string') throw result;
					app.dialog.close();
					app.dialog.alert("La nouvelle idée a bien été envoyée à OSIRI");
					if (self.id) self.nouvelle_idee_update(self.id, result[OSIRI_NOUVELLE_IDEE_PROPERTY_SERVER_ID]);
					else
					{
						self.add().then(function(result)
						{
							self.nouvelle_idee_update(result, result[OSIRI_NOUVELLE_IDEE_PROPERTY_SERVER_ID]);
						});
					}
					// ws_storage.set_value(OSIRI_STORAGE_KEY_IDEE, JSON.stringify({}));
				})
				.catch(function(error)
				{
					app.dialog.close();
					app.dialog.alert("Error : " + error);
				});
			},

            update_stars: function(index, stars_elemnts, icon, color, factor)
            {
                for (var i = 0; i<stars_elemnts.length; i++)
                {
                    if( i == index)
                    {
                        $(stars_elemnts[i]).find('i').removeClass();
                        $(stars_elemnts[i]).find('i').addClass(icon);
                        $(stars_elemnts[i]).css('color', color);
                        var value = i + factor;
                    }
                }
                return value;
            },
            
            add_rex: function()
            {
                var self = this;

                var rex_properties = [
                    OSIRI_REX_PROPERTY_CHANTIER_ID,
                    OSIRI_REX_PROPERTY_PROJET_ID,
                    OSIRI_REX_PROPERTY_VERSION,
                    OSIRI_REX_PROPERTY_DATE_DEBUT,
                    OSIRI_REX_PROPERTY_DATE_FIN,
                    OSIRI_REX_PROPERTY_DATE,
                    OSIRI_REX_PROPERTY_PHOTOS,
                    OSIRI_REX_PROPERTY_COMMENT,
                    OSIRI_REX_PROPERTY_ETAT,
                    OSIRI_REX_PROPERTY_DATA,
                    OSIRI_REX_PROPERTY_MATERIEL_RECEIVED
                ];
                
                var rex_values = [
                    self.chantier_id,
                    self.projet_id,
                    1,
                    ws_tools.get_date_as_string(),
                    "",
                    ws_tools.get_date_as_string(),
                    "",
                    "",
                    "",
                    JSON.stringify(self.data),
                    false
                ];

                return ws_database.rexs.add_with_server(ws_engine.get_server_id(), rex_properties, rex_values);
            
            },

            
            set_value : function(property_id, value, prop_change)
			{
                if (this.data[property_id] == undefined) this.data[property_id] = {};
		
                if (this.data[property_id][prop_change] != value)
                {
                    this.data[property_id][prop_change] = value;
                
                    return this.save();
                }
				
				return Promise.resolve();
			},

			save : function()
			{
				var data = JSON.stringify(this.data);
                
                ws_database.rexs.set_with_id(this.rex_id, [OSIRI_REX_PROPERTY_DATA], [data]);
			},
            
        }));
    </script>
</div>
        