<div class="page" data-name="my-actions-tab">
    <div class="navbar">
        <div class="navbar-bg"></div>
        <div class="navbar-inner sliding">
            <div class="left">
                <a href="#" class="link back">
                <i class="icon icon-back"></i>
                <span class="if-not-md">Back</span>
                </a>
            </div>
            <div class="title">OSIRI - Mes actions</div>
        </div>
    </div>
    <style>
    
    </style>
    <div class="page-content">
        
        <script id="osiri_rex_template" type="text/template7">
            <div class="popover popover-action-photo">
                <div class="popover-inner">
                    <div class="list">
                        <ul>
                            <li><a class="list-button popover-close item-link osiri_rex_take_photo" href="#">Prendre une photo</a></li>
                            <li><a class="list-button popover-close item-link osiri_rex_add_photo" href="#">Galerie du téléphone</a></li>
                        </ul>
                    </div>
                </div>
            </div>
            <!-- <div class="block-title block-title-medium">ERGONOMIE</div>
            <div class="block-title">GÉNÉRAL</div> -->
            <div class="list inset">
                <ul>
                    <li id="ergonomie">
                        <div class="item-content item-input">
                            <div class="item-inner item-title" style="white-space: normal; font-weight: bold">Ergonomie</div>
                            <div class="item-after">
                                <!-- <p class="segmented segmented-raised segmented-round">
                                    <button class="button button-round {{#if ergonomie}}{{#js_if "this.ergonomie.action === 'p'"}}button-active{{/js_if}}{{/if}}" value="p">Positif</button>
                                    <button class="button button-round {{#if ergonomie}}{{#js_if "this.ergonomie.action === 'n'"}}button-active{{/js_if}}{{/if}}" value="n">Négatif</button>
                                </p> -->
                            </div>
                        </div>
                        <div class="osiri_action_option">
                            <div class="stars row" style="margin-left: 10%; margin-right: 10%;">
                                <a class="star item-link"><i class="col fal fa-star"></i></a>
                                <a class="star item-link"><i class="col fal fa-star"></i></a>
                                <a class="star item-link"><i class="col fal fa-star"></i></a>
                                <a class="star item-link"><i class="col fal fa-star"></i></a>
                                <a class="star item-link"><i class="col fal fa-star"></i></a>
                            </div>
                            <div class="item-content item-input">
                                <div class="item-inner" style="display: none; padding-top: 24px;">
                                    <div class="item-input-wrap" style="margin-bottom: 10px;">
                                        <div class="item-subtitle">Commentaire</div>
                                        <textarea class="resizable" style="height: 70px;" placeholder="Commentaire" osiri_content="commentaire">{{#if ergonomie}}{{ ergonomie.commentaire }}{{/if}}</textarea>
                                    </div>
                                    <div class="item-input-wrap">
                                        <div class="item-subtitle">Proposition</div>
                                        <textarea class="resizable" style="height: 70px;" placeholder="Modification proposée" osiri_content="proposition">{{#if ergonomie}}{{ ergonomie.proposition }}{{/if}}</textarea>
                                    </div>
                                </div>
                                <div class="item-media" style="padding: 0; height: 180px; display: none;">
                                    <div style="height: 65px;">
                                        <a class="link popover-open add_photo" osiri_prop="ergonomie" href="#" data-popover=".popover-action-photo" style="width: 40px; height: 40px; padding-left: 17px;">
                                            <i class="f7-icon material-icons md-only">add_a_photo</i>
                                        </a>
                                    </div>
                                </div>
                            </div>
                            <div id="osiri_rex_photos_ergonomie" class="actions-grid modal-in" style="display:{{#if ergonomie}}block{{else}}none{{/if}};">
                                <div class="actions-group">
                                    {{#if ergonomie}}{{#if ergonomie.image}}
                                    <div class="actions-button">
                                        <div class="actions-button-media"><img src="data:application/octet-stream;base64,{{ ergonomie.image }}" width="48"></div>
                                        <div class="actions-button-text dynamic-popover">image</div>
                                    </div>
                                    {{/if}}{{/if}}
                                </div>
                            </div>
                        </div>
                    </li>
                    <li id="securite">
                        <div class="item-content item-input">
                            <div class="item-inner item-title" style="white-space: normal; font-weight: bold">Sécurité</div>
                            <div class="item-after">
                                <!-- <p class="segmented segmented-raised segmented-round">
                                    <button class="button button-round {{#if securite}}{{#js_if "this.securite.action === 'p'"}}button-active{{/js_if}}{{/if}}" value="p">Positif</button>
                                    <button class="button button-round {{#if securite}}{{#js_if "this.securite.action === 'n'"}}button-active{{/js_if}}{{/if}}" value="n">Négatif</button>
                                </p> -->
                            </div>
                        </div>
                        <div class="osiri_action_option">
                            <div class="stars row" style="margin-left: 10%; margin-right: 10%;">
                                <a class="star item-link"><i class="col fal fa-star"></i></a>
                                <a class="star item-link"><i class="col fal fa-star"></i></a>
                                <a class="star item-link"><i class="col fal fa-star"></i></a>
                                <a class="star item-link"><i class="col fal fa-star"></i></a>
                                <a class="star item-link"><i class="col fal fa-star"></i></a>
                            </div>
                            <div class="item-content item-input">
                                <div class="item-inner" style="display: none; padding-top: 24px;">
                                    <div class="item-input-wrap" style="margin-bottom: 10px;">
                                        <div class="item-subtitle">Commentaire</div>
                                        <textarea class="resizable" style="height: 70px;" placeholder="Commentaire" osiri_content="commentaire">{{#if securite}}{{ securite.commentaire }}{{/if}}</textarea>
                                    </div>
                                    <div class="item-input-wrap">
                                        <div class="item-subtitle">Proposition</div>
                                        <textarea class="resizable" style="height: 70px;" placeholder="Modification proposée" osiri_content="proposition">{{#if securite}}{{ securite.proposition }}{{/if}}</textarea>
                                    </div>
                                </div>
                                <div class="item-media" style="padding: 0; height: 180px; display: none;">
                                    <div style="height: 65px;">
                                        <a class="link popover-open add_photo" osiri_prop="securite" href="#" data-popover=".popover-action-photo" style="width: 40px; height: 40px; padding-left: 17px;">
                                            <i class="f7-icon material-icons md-only">add_a_photo</i>
                                        </a>
                                    </div>
                                </div>
                            </div>
                            <div id="osiri_rex_photos_securite" class="actions-grid modal-in" style="display:{{#if securite}}block{{else}}none{{/if}};">
                                <div class="actions-group">
                                    {{#if securite}}{{#if securite.image}}
                                    <div class="actions-button">
                                        <div class="actions-button-media"><img src="data:application/octet-stream;base64,{{ securite.image }}" width="48"></div>
                                        <div class="actions-button-text dynamic-popover">image</div>
                                    </div>
                                    {{/if}}{{/if}}
                                </div>
                            </div>
                        </div>
                    </li>
                    <li id="productivite">
                        <div class="item-content item-input">
                            <div class="item-inner item-title" style="white-space: normal; font-weight: bold">Productivité</div>
                            <div class="item-after">
                                <!-- <p class="segmented segmented-raised segmented-round">
                                    <button class="button button-round {{#if productivite}}{{#js_if "this.productivite.action === 'p'"}}button-active{{/js_if}}{{/if}}" value="p">Positif</button>
                                    <button class="button button-round {{#if productivite}}{{#js_if "this.productivite.action === 'n'"}}button-active{{/js_if}}{{/if}}" value="n">Négatif</button>
                                </p> -->
                            </div>
                        </div>
                        <div class="osiri_action_option">
                            <div class="stars row" style="margin-left: 10%; margin-right: 10%;">
                                <a class="star item-link"><i class="col fal fa-star"></i></a>
                                <a class="star item-link"><i class="col fal fa-star"></i></a>
                                <a class="star item-link"><i class="col fal fa-star"></i></a>
                                <a class="star item-link"><i class="col fal fa-star"></i></a>
                                <a class="star item-link"><i class="col fal fa-star"></i></a>
                            </div>
                            <div class="item-content item-input">
                                <div class="item-inner" style="display: none; padding-top: 24px;">
                                    <div class="item-input-wrap" style="margin-bottom: 10px;">
                                        <div class="item-subtitle">Commentaire</div>
                                        <textarea class="resizable" style="height: 70px;" placeholder="Commentaire" osiri_content="commentaire">{{#if productivite}}{{ productivite.commentaire }}{{/if}}</textarea>
                                    </div>
                                    <div class="item-input-wrap">
                                        <div class="item-subtitle">Proposition</div>
                                        <textarea class="resizable" style="height: 70px;" placeholder="Modification proposée" osiri_content="proposition">{{#if productivite}}{{ productivite.proposition }}{{/if}}</textarea>
                                    </div>
                                </div>
                                <div class="item-media" style="padding: 0; height: 180px; display: none;">
                                    <div style="height: 65px;">
                                        <a class="link popover-open add_photo" osiri_prop="productivite" href="#" data-popover=".popover-action-photo" style="width: 40px; height: 40px; padding-left: 17px;">
                                            <i class="f7-icon material-icons md-only">add_a_photo</i>
                                        </a>
                                    </div>
                                </div>
                            </div>
                            <div id="osiri_rex_photos_productivite" class="actions-grid modal-in" style="display:{{#if productivite}}block{{else}}none{{/if}};">
                                <div class="actions-group">
                                    {{#if productivite}}{{#if productivite.image}}
                                    <div class="actions-button">
                                        <div class="actions-button-media"><img src="data:application/octet-stream;base64,{{ productivite.image }}" width="48"></div>
                                        <div class="actions-button-text dynamic-popover">image</div>
                                    </div>
                                    {{/if}}{{/if}}
                                </div>
                            </div>
                        </div>
                    </li>
                    <li id="competitivite">
                        <div class="item-content item-input">
                            <div class="item-inner item-title" style="white-space: normal; font-weight: bold">Compétitivité</div>
                            <div class="item-after">
                                <!-- <p class="segmented segmented-raised segmented-round">
                                    <button class="button button-round {{#if competitivite}}{{#js_if "this.competitivite.action === 'p'"}}button-active{{/js_if}}{{/if}}" value="p">Positif</button>
                                    <button class="button button-round {{#if competitivite}}{{#js_if "this.competitivite.action === 'n'"}}button-active{{/js_if}}{{/if}}" value="n">Négatif</button>
                                </p> -->
                            </div>
                        </div>
                        <div class="osiri_action_option">
                            <div class="stars row" style="margin-left: 10%; margin-right: 10%;">
                                <a class="star item-link"><i class="col fal fa-star"></i></a>
                                <a class="star item-link"><i class="col fal fa-star"></i></a>
                                <a class="star item-link"><i class="col fal fa-star"></i></a>
                                <a class="star item-link"><i class="col fal fa-star"></i></a>
                                <a class="star item-link"><i class="col fal fa-star"></i></a>
                            </div>
                            <div class="item-content item-input">
                                <div class="item-inner" style="display: none; padding-top: 24px;">
                                    <div class="item-input-wrap" style="margin-bottom: 10px;">
                                        <div class="item-subtitle">Commentaire</div>
                                        <textarea class="resizable" style="height: 70px;" placeholder="Commentaire" osiri_content="commentaire">{{#if competitivite}}{{ competitivite.commentaire }}{{/if}}</textarea>
                                    </div>
                                    <div class="item-input-wrap">
                                        <div class="item-subtitle">Proposition</div>
                                        <textarea class="resizable" style="height: 70px;" placeholder="Modification proposée" osiri_content="proposition">{{#if competitivite}}{{ competitivite.proposition }}{{/if}}</textarea>
                                    </div>
                                </div>
                                <div class="item-media" style="padding: 0; height: 180px; display: none;">
                                    <div style="height: 65px;">
                                        <a class="link popover-open add_photo" osiri_prop="competitivite" href="#" data-popover=".popover-action-photo" style="width: 40px; height: 40px; padding-left: 17px;">
                                            <i class="f7-icon material-icons md-only">add_a_photo</i>
                                        </a>
                                    </div>
                                </div>
                            </div>
                            <div id="osiri_rex_photos_competitivite" class="actions-grid modal-in" style="display:{{#if competitivite}}block{{else}}none{{/if}};">
                                <div class="actions-group">
                                    {{#if competitivite}}{{#if competitivite.image}}
                                    <div class="actions-button">
                                        <div class="actions-button-media"><img src="data:application/octet-stream;base64,{{ competitivite.image }}" width="48"></div>
                                        <div class="actions-button-text dynamic-popover">image</div>
                                    </div>
                                    {{/if}}{{/if}}
                                </div>
                            </div>
                        </div>
                    </li>
                    <li id="environnement">
                        <div class="item-content item-input">
                            <div class="item-inner item-title" style="white-space: normal; font-weight: bold">Environnement</div>
                            <div class="item-after">
                                <!-- <p class="segmented segmented-raised segmented-round">
                                    <button class="button button-round {{#if environnement}}{{#js_if "this.environnement.action === 'p'"}}button-active{{/js_if}}{{/if}}" value="p">Positif</button>
                                    <button class="button button-round {{#if environnement}}{{#js_if "this.environnement.action === 'n'"}}button-active{{/js_if}}{{/if}}" value="n">Négatif</button>
                                </p> -->
                            </div>
                        </div>
                        <div class="osiri_action_option">
                            <div class="stars row" style="margin-left: 10%; margin-right: 10%;">
                                <a class="star item-link"><i class="col fal fa-star"></i></a>
                                <a class="star item-link"><i class="col fal fa-star"></i></a>
                                <a class="star item-link"><i class="col fal fa-star"></i></a>
                                <a class="star item-link"><i class="col fal fa-star"></i></a>
                                <a class="star item-link"><i class="col fal fa-star"></i></a>
                            </div>
                            <div class="item-content item-input">
                                <div class="item-inner" style="display: none; padding-top: 24px;">
                                    <div class="item-input-wrap" style="margin-bottom: 10px;">
                                        <div class="item-subtitle">Commentaire</div>
                                        <textarea class="resizable" style="height: 70px;" placeholder="Commentaire" osiri_content="commentaire">{{#if environnement}}{{ environnement.commentaire }}{{/if}}</textarea>
                                    </div>
                                    <div class="item-input-wrap">
                                        <div class="item-subtitle">Proposition</div>
                                        <textarea class="resizable" style="height: 70px;" placeholder="Modification proposée" osiri_content="proposition">{{#if environnement}}{{ environnement.proposition }}{{/if}}</textarea>
                                    </div>
                                </div>
                                <div class="item-media" style="padding: 0; height: 180px; display: none;">
                                    <div style="height: 65px;">
                                        <a class="link popover-open add_photo" osiri_prop="environnement" href="#" data-popover=".popover-action-photo" style="width: 40px; height: 40px; padding-left: 17px;">
                                            <i class="f7-icon material-icons md-only">add_a_photo</i>
                                        </a>
                                    </div>
                                </div>
                            </div>
                            <div id="osiri_rex_photos_environnement" class="actions-grid modal-in" style="display:{{#if environnement}}block{{else}}none{{/if}};">
                                <div class="actions-group">
                                    {{#if environnement}}{{#if environnement.image}}
                                    <div class="actions-button">
                                        <div class="actions-button-media"><img src="data:application/octet-stream;base64,{{ environnement.image }}" width="48"></div>
                                        <div class="actions-button-text dynamic-popover">image</div>
                                    </div>
                                    {{/if}}{{/if}}
                                </div>
                            </div>
                        </div>
                    </li>
                    <li id="autre">
                        <div class="item-content item-input">
                            <div class="item-inner item-title" style="white-space: normal; font-weight: bold">Autre</div>
                            <div class="item-after">
                                <!-- <p class="segmented segmented-raised segmented-round">
                                    <button class="button button-round {{#if autre}}{{#js_if "this.autre.action === 'p'"}}button-active{{/js_if}}{{/if}}" value="p">Positif</button>
                                    <button class="button button-round {{#if autre}}{{#js_if "this.autre.action === 'n'"}}button-active{{/js_if}}{{/if}}" value="n">Négatif</button>
                                </p> -->
                            </div>
                        </div>
                        <div class="osiri_action_option">
                            <div class="stars row" style="margin-left: 10%; margin-right: 10%;">
                                <a class="star item-link"><i class="col fal fa-star"></i></a>
                                <a class="star item-link"><i class="col fal fa-star"></i></a>
                                <a class="star item-link"><i class="col fal fa-star"></i></a>
                                <a class="star item-link"><i class="col fal fa-star"></i></a>
                                <a class="star item-link"><i class="col fal fa-star"></i></a>
                            </div>
                            <div class="item-content item-input" style="margin-bottom: 10px;">
                                <div class="item-inner" style="display: none; padding-top: 24px;">
                                    <div class="item-input-wrap" style="margin-bottom: 10px;">
                                        <div class="item-subtitle">Commentaire</div>
                                        <textarea class="resizable" style="height: 70px;" placeholder="Commentaire" osiri_content="commentaire">{{#if autre}}{{ autre.commentaire }}{{/if}}</textarea>
                                    </div>
                                    <div class="item-input-wrap">
                                        <div class="item-subtitle">Proposition</div>
                                        <textarea class="resizable" style="height: 70px;" placeholder="Modification proposée" osiri_content="proposition">{{#if autre}}{{ autre.proposition }}{{/if}}</textarea>
                                    </div>
                                </div>
                                <div class="item-media" style="padding: 0; height: 180px; display: none;">
                                    <div style="height: 65px;">
                                        <a class="link popover-open add_photo" osiri_prop="autre" href="#" data-popover=".popover-action-photo" style="width: 40px; height: 40px; padding-left: 17px;">
                                            <i class="f7-icon material-icons md-only">add_a_photo</i>
                                        </a>
                                    </div>
                                </div>
                            </div>
                            <div id="osiri_rex_photos_autre" class="actions-grid modal-in" style="display:{{#if autre}}block{{else}}none{{/if}};">
                                <div class="actions-group">
                                    {{#if autre}}{{#if autre.image}}
                                    <div class="actions-button">
                                        <div class="actions-button-media"><img src="data:application/octet-stream;base64,{{ autre.image }}" width="48"></div>
                                        <div class="actions-button-text dynamic-popover">image</div>
                                    </div>
                                    {{/if}}{{/if}}
                                </div>
                            </div>
                        </div>
                    </li>
                </ul>
            </div>
        </script>
        
		<div id="osiri_rex_content"></div>
    </div>
    <script type="text/javascript" ws_script="page">
        ws_engine.register_page("my-actions-tab", ws_page.extend(
        {
            custom_init: function(page, event, params)
            {
                var self = this;

			    self.action_id = self.params.action_id;
			    self.chantier_id = self.params.chantier_id;
			    self.projet_id = self.params.projet_id;

                self.data = {};
                self.template_data = {};
                self.template_data.imgs = [];
                
                function init_context()
                {
                    var condition = OSIRI_REX_PROPERTY_CHANTIER_ID+" = ? AND "+ OSIRI_REX_PROPERTY_PROJET_ID+" = ?";
                    var binding = [self.chantier_id, self.projet_id];

                    return ws_database.rexs.get(condition, binding).then(function(result)
                    {
                        self.is_new = (result == null);
                        if (!self.is_new) 
                        {
                            self.rexs = result;
                            self.rex_id = result.id;
                            self.data = JSON.parse(result.data);
                        }
                        else return self.add_rex().then(function(id)
                        {
                            self.rex_id = id;
                        });
                    });
                }
                init_context().then(function()
                {
                    return self.load_page();
                });
            },

            init_data: function()
            {
                var properties = Object.keys(this.data);
            },
            
            load_page: function()
            {
                var self = this;
                var prop;

                self.template_data = self.data;

                return self.apply_template(page, "osiri_rex_template", "osiri_rex_content", self.template_data).then(function()
				{
                    var properties = Object.keys(self.data);
                    var color = 'yellow';
                    var icon = 'col fas fa-star';

                    for (var i = 0; i<properties.length; i++)
                    {
                        var stars_nbr = self.data[properties[i]].action;
                        if (stars_nbr)
                        {
                            var stars = $('#'+ properties[i]).find('.stars');
                            stars.next().find('.item-inner').css('display', 'block');
                            stars.next().find('.item-media').css('display', 'block');
                            
                            var stars_elements = $('#'+ properties[i]).find('.stars').children();
                            
                            for ( var j = 0 ; j<stars_nbr; j++)
                            {
                                $(stars_elements[j]).find('i').removeClass();
                                $(stars_elements[j]).find('i').addClass(icon);
                                $(stars_elements[j]).css('color', color);
                            }
                        }
                    }
                    
                    var option_element = $("#osiri_rex_content");
                    $$('.add_photo').on('click', function (e)
                    {
                        prop = $(this).attr('osiri_prop');
                    });

					// affectation d'une nouvelle image
					option_element.find(".osiri_rex_take_photo").click(function()
					{
						osiri_photos.take_photo(Camera.PictureSourceType.CAMERA).then(function(base64)
						{
							option_element.find("#osiri_rex_photos_"+ prop)[0].style.display = "block";
                            $('#osiri_rex_photos_'+ prop +' div.actions-group').append('<div class="actions-button"><div class="actions-button-media"><img src="data:application/octet-stream;base64,'+ base64 +'" width="48"></div><div class="actions-button-text dynamic-popover">image</div></div>');
							self.set_value(prop, base64, OSIRI_NOUVELLE_IDEE_OPTION_KEY_IMAGE);
						});
                    });
                    
					// affectation d'une image deja stocker dans la galerie du telephone
					option_element.find(".osiri_rex_add_photo").click(function(e)
					{
						osiri_photos.take_photo(Camera.PictureSourceType.PHOTOLIBRARY).then(function(base64)
						{
                            option_element.find("#osiri_rex_photos_"+ prop)[0].style.display = "block";
                            $('#osiri_rex_photos_'+ prop +' div.actions-group').append('<div class="actions-button"><div class="actions-button-media"><img src="data:application/octet-stream;base64,'+ base64 +'" width="48"></div><div class="actions-button-text dynamic-popover">image</div></div>');
							self.set_value(prop, base64, OSIRI_NOUVELLE_IDEE_OPTION_KEY_IMAGE);
						});
                    });
                    
                    $("#osiri_rex_content textarea").change(function()
					{   
                        var id = $(this).parent().parent().parent().parent().parent().attr('id');
                        var content = $(this).attr('osiri_content');
                        
						self.set_value(id, $$(this).val(), content);
                    });
                    
                    $('.list li .item-content button').click(function(e)
                    {
                        var id = $$(this).parent().parent().parent().parent().attr("id");
                        var buttons = $$(this).parent().find(".button");
                        var value = $$(this).val();

                        buttons.removeClass("button-active");
                        $$(this).parent().find(".button[value='"+ value +"']").addClass("button-active");

						self.set_value(id, value, OSIRI_NOUVELLE_IDEE_OPTION_KEY_ACTION);
                    });

                    $('.star').click(function()
                    {
                        var stars = $(this).parent();
                        stars.next().find('.item-inner').css('display', 'block');
                        stars.next().find('.item-media').css('display', 'block');

                        var id = stars.parent().parent().attr("id");
                        var stars_elemnts = stars.children();
                        var color = 'yellow';
                        var icon = 'col fas fa-star';

                        for (var i = 0; i<stars_elemnts.length; i++)
                        {
                            $(stars_elemnts[i]).find('i').removeClass();
                            $(stars_elemnts[i]).find('i').addClass(icon);
                            $(stars_elemnts[i]).css('color', color);

                            if( i == $(this).index())
                            {
                                color = '';
                                icon = 'col fal fa-star';
                                var value = i+1;
                            }
                        }
                        
						self.set_value(id, value, OSIRI_NOUVELLE_IDEE_OPTION_KEY_ACTION);
                    });
                });
            },
            
            add_rex: function()
            {
                var self = this;

                var rex_properties = [
                    OSIRI_REX_PROPERTY_CHANTIER_ID,
                    OSIRI_REX_PROPERTY_PROJET_ID,
                    OSIRI_REX_PROPERTY_VERSION,
                    OSIRI_REX_PROPERTY_DATE_DEBUT,
                    OSIRI_REX_PROPERTY_DATE_FIN,
                    OSIRI_REX_PROPERTY_DATE,
                    OSIRI_REX_PROPERTY_PHOTOS,
                    OSIRI_REX_PROPERTY_COMMENT,
                    OSIRI_REX_PROPERTY_ETAT,
                    OSIRI_REX_PROPERTY_DATA
                ];
                
                var rex_values = [
                    self.chantier_id,
                    self.projet_id,
                    1,
                    ws_tools.get_date_as_string(),
                    "",
                    ws_tools.get_date_as_string(),
                    "",
                    "",
                    "",
                    JSON.stringify(self.data)
                ];

                return ws_database.rexs.add_with_server(ws_engine.get_server_id(), rex_properties, rex_values);
            
            },

            
            set_value : function(property_id, value, prop_change)
			{
                if (this.data[property_id] == undefined) this.data[property_id] = {};
		
                if (this.data[property_id][prop_change] != value)
                {
                    this.data[property_id][prop_change] = value;
                
                    return this.save();
                }
				
				return Promise.resolve();
			},

			save : function()
			{
				var data = JSON.stringify(this.data);
                
                ws_database.rexs.set_with_id(this.rex_id, [OSIRI_REX_PROPERTY_DATA], [data]);
			},
            
        }));
    </script>
</div>
        