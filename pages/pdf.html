<div class="page" data-name="pdf">
	<div class="navbar">
		<div class="navbar-inner sliding">
			<div class="left"><a href="#" class="link back"><i class="icon icon-back"></i><span class="ios-only">Retour</span></a></div>
			<div class="title">OSIRI Mobile - PDF</div>
		</div>
	</div>
	<style type="text/css">
		#upload-button
		{
			width: 150px;
			display: block;
			margin: 20px auto;
		}
		
		#file-to-upload
		{
			display: none;
		}
		
		#pdf-main-container
		{
			width: 100%;
			margin: 0 auto;
		}
		
		#pdf-loader
		{
			display: none;
			text-align: center;
			color: #999999;
			font-size: 13px;
			line-height: 100px;
			height: 100px;
		}
		
		#pdf-contents
		{
			display: none;
		}
		
		#pdf-meta
		{
			overflow: hidden;
			margin:0;
		}
		
		#pdf-buttons
		{
			float: left;
			width:100%;
			padding:0;
			background:#111;
			color:white;
			position:fixed;
			bottom:0;
		}
		
		*
		{
			padding:0;
			margin:0;
		}
		
		#page-count-container
		{
			/*float: left;*/
			display:inline-block;
			width:25%;
			border:0;
			background:#111;
			color:white;
			text-align: center;
			font-size: 20px;
		}
		
		#pdf-current-page
		{
			display: inline;
		}
		
		#pdf-total-pages
		{
			display: inline;
		}
		
		#pdf-canvas
		{
			border: 1px solid rgba(0,0,0,0.2);
			box-sizing: border-box;
			max-width: 100%;
			min-width: 50%;
			margin-left:0px;
		}
		
		#page-loader
		{
			height: 100px;
			line-height: 100px;
			text-align: center;
			display: none;
			color: #999999;
			font-size: 13px;
		}
		
		#pdf-info-zoom
		{
			position:fixed;
			font-size:15px;
			right:0;
			background:white;
			padding:5px;
		}
		
		.navigation
		{
			width:calc(12.5%);
			border:0;
			font-size: 25px;
			background:#111;
			color:white;
			padding-top: 10px;
			padding-bottom: 10px;
			border-left: solid darkgrey 1px;
			border-right: solid darkgrey 1px;
			outline: none;
		}
		
		.navigation>img
		{
			border:0;
			height:25px;
		}
		
		#board>button
		{
			width:calc(50% - 2px);
			font-size:20px;
			padding-top:30px;
			padding-bottom: 30px;
		}
	</style>
	<div class="page-content">
	    <div class="block">
		    <div id="pdf-main-container">
				<div id="pdf-loader">Loading document ...</div>
				<div id="pdf-contents">
					<div id="pdf-meta">
						<div id="pdf-buttons"></div>
					</div>
                    
					<canvas id="pdf-canvas" width="2000"></canvas>
					<div id="page-loader">Loading page ...</div>
					
					<div class="toolbar toolbar-bottom-md" id="basic-tools" style="bottom:0;position:fixed; margin-bottom: 56px; background-color: skyblue;">
						<div class="toolbar-inner">
							<a class="link" id="pdf-first"><img style="transform:rotate(-90deg)" src="icon/first.png"/></a>
							<a class="link" id="pdf-prev"><img src="icon/prev.png"/></a>
							<a class="link" id="pdf-unzoom"><img src="icon/zoomOut.png"/></a>
							<span style="font-size:20px;padding-left:5px;padding-right:5px;"><div id="pdf-current-page"></div>/<div id="pdf-total-pages"></div></span>
							<a class="link" id="pdf-zoom"><img src="icon/zoomIn.png"/></a>
							<a class="link" id="pdf-next"><img src="icon/next.png"/></a>
							<a class="link" id="pdf-last"><img style="transform:rotate(-90deg)" src="icon/last.png"/></a>
						</div>
					</div>
				</div>
			</div>
	    </div>
	</div>
	
	<script type="text/javascript" ws_script="page">
	ws_engine.register_page("pdf", ws_page.extend(
	{
		custom_init: function(page, event, params)
		{
			var self = this;
			var canvas = document.getElementById("pdf-main-container");
			
			self.id = params.id;
			
			var touchstartX = 0;
            var touchendX = 0;
            
			var translatePos = { x: 0, y: 0 };
			var startDragOffset = {};
	        var mouseDown = false;
	        
	        var clickTimer = null;
			
			var click = (app.device.desktop) ? ['mousedown', 'mouseup', 'mousemove'] : ['touchstart', 'touchend', 'touchmove'];
            
			function on_click_0(e)
			{
				touchstartX = (app.device.desktop) ?  e.screenX : e.changedTouches[0].screenX;
			}
			
			function swipeLorR(e)
			{
				var current_page = parseInt($("#pdf-current-page").text(), 10);
				var total_pages = parseInt($("#pdf-total-pages").text(), 10);
				
				touchendX = (app.device.desktop) ?  e.screenX : e.changedTouches[0].screenX;
			    
			    if (touchendX < touchstartX)
			    {
			        if (current_page != total_pages) showPage(++current_page);
			    }
			    if (touchendX > touchstartX)
			    {
			        if (current_page != 1) showPage(--current_page);
			    }
			}
			
			function translate_pos(e)
            {
                if (mouseDown)
                {
                    if (app.device.desktop)
					{
                        translatePos.x = e.clientX - startDragOffset.x;
                        translatePos.y = e.clientY - startDragOffset.y;
                    }
                    else
                    {
	                    translatePos.x = e.touches[0].clientX - startDragOffset.x;
                        translatePos.y = e.touches[0].clientY - startDragOffset.y;
					}
                    
                	canvas.style.left = translatePos.x + "px";
                    canvas.style.top = translatePos.y + "px";
                }
            }
            
            function startranslat(e)
			{
				mouseDown = true;
				
                if (app.device.desktop)
				{
					startDragOffset.x = e.clientX - translatePos.x;
					startDragOffset.y = e.clientY - translatePos.y;
				}
				else
				{
					startDragOffset.x = e.touches[0].clientX - translatePos.x;
					startDragOffset.y = e.touches[0].clientY - translatePos.y;
				}
			}
			
			function mouse_up(e)
			{
				mouseDown = false;
			}
			
			function touchStart() 
			{
			    if (clickTimer == null)
			    {
			        clickTimer = setTimeout(function()
			        {
			            clickTimer = null;
			            //alert("single");
			
			        }, 500)
			    } 
			    else 
			    {
			        clearTimeout(clickTimer);
			        clickTimer = null;
			        
			        // Double click
			        //resize and reposition the canvas
					document.getElementById("pdf-canvas").style.maxWidth = "100%";
					$("#basic-tools").attr('ws_zoom', "100");
					canvas.style.left = (document.getElementById("pdf-contents").offsetWidth - document.getElementById("pdf-canvas").offsetWidth)/2 + "px";
	                canvas.style.top = "0px";
	                
					// add event listeners to swipe
					canvas.addEventListener(click[1], swipeLorR, false);
					// remove event listeners to handle screen drag
					canvas.removeEventListener(click[2], translate_pos, false);
			    }
			}
			
			canvas.addEventListener(click[0], on_click_0, false);
			canvas.addEventListener(click[1], swipeLorR, false);
			canvas.addEventListener('click', touchStart);
			
			$("#pdf-zoom").click(function()
			{
				if ($("#basic-tools").attr('ws_zoom') != "100")
                {
	                // add event listeners to handle screen drag
	                canvas.addEventListener(click[0], startranslat, false);
	                canvas.addEventListener(click[1], mouse_up, false);
	                canvas.addEventListener(click[2], translate_pos, false);
	                
	                // remove event listeners to swipe
	                canvas.removeEventListener(click[1], swipeLorR, false);
                }
			});
			
			$("#pdf-unzoom").click(function()
			{
				if ($("#basic-tools").attr('ws_zoom') != "100")
                {
	                // add event listeners to handle screen drag
	                canvas.addEventListener(click[0], startranslat, false);
	                canvas.addEventListener(click[1], mouse_up, false);
	                canvas.addEventListener(click[2], translate_pos, false);
	                
	                // remove event listeners to swipe
	                canvas.removeEventListener(click[1], swipeLorR, false);
                }
			});
            
			if (self.id)
            {
                return new Promise(function(resolve, rejecte)
                {
                     $.getScript("libs/pdfjs/utils.js", function()
                    {
                        console.log("fichier utils est bien charger");
                        return resolve(true);
                    });
                })
                .then(function(file)
                {
                    return ws_database.files.get_with_server_id(1, self.id);
                })
                .then(function(file)
                {
                    self.file = file;

                    if (file.path)
                    {
                        // if file's base 64 in database
                        app.dialog.preloader("Chargement de fichier...");

                        return op2a_photos.get_photo_as_data_url(file.path).then(function(pdfData_binary)
                        {
                            var pdfData_base64 = atob(pdfData_binary.substr(13));
                            init();
                            showPDF(pdfData_base64);
                            app.dialog.close();
                        });
                    } 
                    else
                    {
                        // if not we will download its
                        var param = {};

                        app.dialog.preloader("TÃ©lechargement en cours...");
                        
                        param.server_id = self.file.server_id;
                        //param.base64 = WS_VALUE_DOWNLOAD_BASE64;

                        return ws_server.download_file(param).then(function(pdfData_binary)
                        {
                            debugger
                           /* return btoa(pdfData_base64);
                        })
                        .then(function(pdfData_binary)
                        {
                            debugger*/
                            init();
                            showPDF({ data: pdfData_binary});
                            op2a_documents.add_binary_pdf(chantier_id, self.file.name, "application/pdf", pdfData_binary, chantier.data.type);
                            app.dialog.close();
                        })
                        .catch(function(error)
						{
							app.dialog.close();
							app.dialog.alert(error);
							console.log(error);
						});
                    }
                });
            }
            else
            {
                return new Promise(function(resolve, rejecte)
                {
                     $.getScript("libs/pdfjs/utils.js", function()
                    {
                        console.log("fichier utils est bien charger");
                        return resolve(true);
                    });
                })
                .then(function()
                {
                    init();
                    showPDF({ data: atob(ws_defines.PDF_EXEMPLE)});
                });
                
            }
						
		},
	}));	
	</script>
</div>
