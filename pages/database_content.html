<div class="page" data-name="database_content">
	<div class="navbar">
		<div class="navbar-bg"></div>
		<div class="navbar-inner sliding">
			<div class="left">
				<a href="#" class="link back">
					<i class="icon icon-back"></i>
				<span class="ios-only">Back</span>
				</a>
			</div>			
			<div class="title">OSIRI Mobile - Contenu de la base de données</div>
			<div class="right">
			</div>
		</div>
	</div>
	<div class="page-content">
		<script id="database_content_template" type="text/template7">			
<!--
			<div class="block card ws_app_event_card">
				<div class="ws_app_page_header_block">
					<div class= "ws_app_page_header">Contenu de la base de données</div>
				</div>
			</div>
-->
		   <div class="list no-hairlines-md">
			  <ul>
				  <li class="item-content item-input">
				      <div class="item-inner">
				        <div class="item-title item-label">Table</div>
				        <div class="item-input-wrap input-dropdown-wrap">
					        <select placeholder="Please choose..." id="oe_entities_select">
						        {{#each entities}}
						        <option value="{{ this }}">{{ this }}</option>
						        {{/each}}
						    </select>
				        </div>
				      </div>
				  </li>
			  </ul>
		   </div>
    		<div class="card data-table">
				<table>
				    <thead id="oe_propoerties">
				      <tr>
					      <th class="label-cell">id</th>
					      <th class="label-cell">url</th>
					      <th class="label-cell">token</th>
					      <th class="label-cell">device_id</th>
					      <th class="label-cell">map</th>
					      <th class="label-cell">data_model</th>
				      </tr>
				    </thead>
				    <tbody id="oe_data">
				    </tbody>
			  	</table>
				<div class="data-table-footer">
				    <div class="data-table-rows-select">
				      Per page:
				      <div class="input input-dropdown">
				        <select id="oe_page_select">
				          <option value="5">5</option>
				          <option value="10">10</option>
				          <option value="25">25</option>
				          <option value="all">All</option>
				        </select>
				      </div>
				    </div>
				    <div class="data-table-pagination">
				      <span class="data-table-pagination-label" id="oe_page_number">1-5 of 10</span>
				      <a href="#" class="link disabled" id="oe_prev_page">
				        <i class="icon icon-prev color-gray"></i>
				      </a>
				      <a href="#" class="link" id="oe_next_page">
				        <i class="icon icon-next color-gray"></i>
				      </a>
				    </div>
				</div>
			</div>
		</script>
		<div id="database_content">
		</div>
	</div>
	
	<script type="text/javascript" ws_script="page">
	ws_engine.register_page("database_content", ws_page.extend(
	{	
		custom_init: function(page, event, params)
		{
			var self = this;
			var data = {};
			var template = $$('#database_content_template').html();
			var compiled_template = Template7.compile(template);
			var page_num = 1;
			
			return ws_database.servers.all().then(function(servers)
			{
				data = servers;
				data.entities = ws_database.get_tables();
				
				var html = compiled_template(data);
				$$('#database_content').html(html);

				self.get_template_for_data(servers, page_num);
				
				$$('select#oe_page_select').change(function()
				{
					page_num = 1;
					self.on_change_number(self, page_num);
				});
				
				$('#oe_next_page').on('click',function()
				{
					page_num++;
					self.on_change_number(self, page_num);
				});
				
				$('#oe_prev_page').on('click',function()
				{
					page_num--;
					self.on_change_number(self, page_num);
				});
				
				$('select#oe_entities_select').on('change',function()
				{
					var entity_selected = $$(this)[0].selectedOptions[0].value;
					var structure = ws_datamodel.get_entity_structure(entity_selected);
					
					$("#oe_propoerties tr th").remove();
					$("#oe_data tr").remove();
					
					for(var i = 0; i<structure.length; i++)
					{
						$("#oe_propoerties tr").append('<th class="label-cell">'+ structure[i].id +'</th>');
					}
					
					var entity_selected_infos = ws_datamodel.get_entity_infos(entity_selected);
					
					return entity_selected_infos.db.all().then(function(entities_data)
					{
						self.get_template_for_data(entities_data, page_num);
					});		
				
				});		
			});
			
			return true;
		},
		
		get_template_for_data : function (data, page_num) 
		{
			var self = this;
			for(var i = 0; i<data.length; i++)
			{
				var j =0;
				$("#oe_data").append('<tr></tr>');
				
				$.each( data[i], function( key, value ) {
					$($("#oe_data tr")[i]).append('<td class="label-cell"></td>');
					$("#oe_data tr")[i].children[j].innerHTML = value;
					j++;
				});
			}
			self.on_change_number(undefined, page_num);
		},
		
		on_change_page : function (longueur, page_num) 
		{
			var col = parseInt($$($('select#oe_page_select'))[0].selectedOptions[0].value);
			var number = Math.trunc(longueur/col);
			var total_number_page;
			
			if ((longueur%col) == 0 && longueur != 0) 
			{
				total_number_page = number;
				$("#oe_page_number").html(page_num + " of " + total_number_page);
			}
			else
			{
				total_number_page = number + 1;
				if (col < longueur) 
				{
					$("#oe_page_number").html(page_num + " of " + total_number_page);
				}
				else $("#oe_page_number").html(1 + " of " + 1);
			}
			
			if (page_num <=1 ) 	$$("#oe_prev_page").attr("class","link disabled");
			else 	$$("#oe_prev_page").attr("class","link");
			
			if (page_num >= total_number_page) 	$$("#oe_next_page").attr("class","link disabled");
			else 	$$("#oe_next_page").attr("class","link");
		},
		
		on_change_number : function (self, page_num) 
		{
			if (self == undefined) self = this;
			var col = parseInt($$($('select#oe_page_select'))[0].selectedOptions[0].value);
			var len = $("#oe_data tr").length;
			
			for (var i = 0; i < len; i++) 
			{
				if ( i <(col * (page_num-1)) || i > ((col*page_num)-1)) $($("#oe_data tr")[i]).hide();
				else $($("#oe_data tr")[i]).show()
			}
			self.on_change_page(len, page_num);
		}
	}));
	</script>
</div>
