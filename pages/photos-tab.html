<div class="page" data-name="photos-tab">
	<div class="navbar">
		<div class="navbar-inner">
			<div class="left"></div>
			<div class="title">OP2A Mobile - Photos</div>
			<div class="right">
				<a href="#" class="link icon-only" id="op2a_photos_take">
					<i class="icon f7-icons ios-only">camera</i>
					<i class="icon material-icons md-only">add_a_photo</i>
				</a>
				<a href="#" class="link icon-only" id="op2a_photos_browse">
					<i class="icon f7-icons ios-only">tabs</i>
					<i class="icon material-icons md-only">panorama</i>
				</a>
			</div>
		</div>
	</div>

	<div class="page-content">
		<style>
		#op2a_photos_list .item-media
		{
			width: 33%;
		}
		
		#op2a_photos_list .item-media img
		{
			max-height: 100px;
			max-width: 180px;
			margin-top: 10px;;
			margin-bottom: 10px;;
		}
		
		#op2a_photos_list .item-title
		{
			font-weight: bold;
		}
		
/*
		#op2a_photos_list .item-text
		{
			color: lightgrey;
		}
*/
		</style>

		<script id="op2a_photos_template" type="text/template7">	
			{{#if has_photos}}
			<div class="list media-list" id="op2a_photos_list">
				<ul>
					{{#each photos}}
					<li class="{{#if deletable}}swipeout delete-callback{{/if}}" ws_id="{{id}}">
						<a href="/photo/{{ id }}" class="item-link item-content swipeout-content">
							<div class="item-media"><img src="{{ source }}" /></div>
							<div class="item-inner">
								<div class="item-title-row">
									<div class="item-title">
										<div class="item-header">{{ date }}</div>
										{{ name }}
									</div>
								</div>
<!-- 								<div class="item-subtitle">{{ date }}</div> -->
								{{#if has_chantier}}<div class="item-subtitle">{{ chantier_name }}</div>{{/if}}
								{{#if has_materiel}}<div class="item-subtitle">{{ materiel_name }}</div>{{/if}}
<!-- 								{{#if has_operation}}<div class="item-text">{{ comment }}</div>{{/if}} -->
								<div class="item-text">{{ comment }}</div>
							</div>
						</a>
						{{#if deletable}}
						<div class="swipeout-actions-right">
							<a href="#" class="swipeout-delete" data-confirm="Supprimer cette photo ?" data-confirm-title="Supprimer">Supprimer</a>
						</div>
						{{/if}}
					</li>
					{{/each}}
				</ul>
			</div>
			{{else}}
			<div class="block-title">Aucune photo</div>
			{{/if}}
		</script>
		
		<div id="op2a_photos_content">
		</div>
	</div>
	
	<script type="text/javascript" ws_script="page">
	ws_engine.register_page("photos-tab", ws_page.extend(
	{	
		custom_init: function(page, event, params)
		{
			var self = this;
			var data = { has_photos: false };
			

			self.on_click(page, "#op2a_photos_take", op2a_photos.take_picture);
			self.on_click(page, "#op2a_photos_browse", op2a_photos.choose_picture);
/*
			if (ws_engine.has_server())
			{
				self.on_click(page, "#op2a_photos_take", self.take_picture);
				self.on_click(page, "#op2a_photos_browse", self.choose_picture);
			}
			else
			{
				self.get_element("op2a_photos_take").hide();
				self.get_element("op2a_photos_browse").hide();
			}
*/			
			return Promise.resolve(true);
		},
				
		custom_tabshow: function(page, event, params)
		{
			return this.reload_template(this, page, event, params);
		},
		
		custom_beforein: function(page, event, params)
		{
			return this.reload_template(this, page, event, params);
		},
		
		reload_template: function(self, page)
		{
			var data = { has_photos: false, photos: [] };
			var server_id = ws_engine.get_server_id();
		
			if (server_id != undefined) return ws_database.files.all_with_server(server_id).then(function(files)
			{
				var photos = []
				
				if (files.length > 0) for (var i = 0; i < files.length; i++)
				{
					if (files[i].type == WS_FILE_KEY_IMAGE) photos.push(files[i]);
				}
				
				return op2a_photos.get_photos_template_data(photos);
			})
			.then(function(photos_template_data)
			{
				data.photos = photos_template_data;
				data.has_photos = data.photos.length > 0;
				
				return self.apply_template(page, "op2a_photos_template", "op2a_photos_content", data);
			})
			.then(function()
			{
				self.on_event(page, ".swipeout.delete-callback", "swipeout:deleted", self.swipeout_photo_delete);
			});
		},
		
		swipeout_photo_delete: function(self, page, selector, event)
		{
			var id = $$(event.target).attr("ws_id");
			
			return op2a_photos.delete_photo(id).catch(function(error)
			{
				app.dialog.alert(error);
			});
		},
	}));
	</script>
</div>
