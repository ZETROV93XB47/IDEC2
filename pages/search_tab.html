<div class="page" data-name="search-tab">
	<div class="navbar">
		<div class="navbar-inner">
			<div class="title">OP2A Mobile - Recherche</div>
		</div>
	</div>
	
	<div class="searchbar-backdrop"></div>
	<form id="op2a_search_bar" class="searchbar">
		<div class="searchbar-inner">
			<div class="searchbar-input-wrap">
				<input type="search" placeholder="Chercher...">
				<i class="searchbar-icon"></i>
				<span class="input-clear-button"></span>
			</div>
			<span class="searchbar-disable-button">Annuler</span>
		</div>
	</form>
	
	<div class="page-content">
		<div class="ws_app_page_header_block searchbar-hide-on-search">
			<div class="ws_app_page_header">Recherche</div>
			<div>Saisissez au moins 3 caractères</div>
		</div>
		
		<div class="list media-list searchbar-found" id="op2a_search_list">
			<ul id="op2a_search_list_content">
				
			</ul>
		</div>
		
		<!-- Nothing found message -->
		<div class="block searchbar-not-found">
			<div class="block-inner">Résultat vide.</div>
		</div>
	</div>
	
	<script id="op2a_search_list_template" type="text/template7">			
		{{#each search_items}}
		<li>
			<a href="{{link}}" class="item-link item-content">
				<div class="item-inner">
					<div class="item-title-row">
						<div class="item-title">{{libelle}}</div>
						<div class="item-after">{{after}}</div>
					</div>
					<div class="item-after">{{commentaire}}</div>
				</div>
			</a>
		</li>
		{{/each}}
	</script>		
	
	<script type="text/javascript" ws_script="page">
	ws_engine.register_page("search-tab", ws_page.extend(
	{	
		custom_init: function(page, event, params)
		{
			var self = this;
			
			var searchbar = app.searchbar.create(
			{
				el: '#op2a_search_bar',
				searchContainer: '#op2a_search_list',
				searchIn: '.item-title',
				customSearch: true,
				on: {
					search(sb, query, previousQuery)
					{
						var data = { search_items: [] };
							
						if (query.length >= 3)
						{
							ws_database.chantiers.search(query, [
								OP2A_CHANTIER_PROPERTY_NOM, OP2A_CHANTIER_PROPERTY_CI,
								OP2A_CHANTIER_PROPERTY_CP,
								OP2A_CHANTIER_PROPERTY_VILLE
							])
							.then(function (chantiers)
							{
								return op2a_chantiers.get_chantiers_search_list_template_data(chantiers);
							})
							.then(function(chantiers_template_data)
							{									
								data.search_items = data.search_items.concat(chantiers_template_data);
								
								return ws_database.materiels.search(query, [OP2A_MATERIEL_PROPERTY_DESIGNATION]);
							})
							.then(function(materiels)
							{
								return op2a_materiels.get_materiels_search_list_template_data(materiels);
							})
							.then(function(materiels_template_data)
							{
								data.search_items = data.search_items.concat(materiels_template_data);
												
								return ws_database.contacts.search(query, [
									OP2A_CONTACT_PROPERTY_LASTNAME,
									OP2A_CONTACT_PROPERTY_FIRSTNAME,
									OP2A_CONTACT_PROPERTY_COMPANY,
									OP2A_CONTACT_PROPERTY_ABREVIATION,
									OP2A_CONTACT_PROPERTY_EMAIL,
									OP2A_CONTACT_PROPERTY_PHONE_NUMBER
								]);
							})
							.then(function(contacts)
							{
								return op2a_contacts.get_contacts_search_list_template_data(contacts);
							})
							.then(function(contacts_template_data)
							{
								data.search_items = data.search_items.concat(contacts_template_data);
								
								if (data.search_items) data.search_items.sort((a,b) => (a.libelle > b.libelle ? 1 : (a.libelle < b.libelle ? -1 : 0 )));
								
								self.apply_template(page, "op2a_search_list_template", "op2a_search_list_content", data);
							});	
						}
						else
						{
							self.apply_template(page, "op2a_search_list_template", "op2a_search_list_content", data);
						}			
					}
				}
			});
		},
	}));
	</script>
</div>
