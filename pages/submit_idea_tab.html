<div class="page" data-name="submit-idea-tab">
	<div class="navbar">
		<div class="navbar-bg"></div>
		<div class="navbar-inner sliding">
			<div class="title">OSIRI - Idée</div>
			<div class="right">
				<a href="#" id="osiri_upload_idea" class="link icon-only"><i class="fa fa-check submit" style="font-size:20px;"></i></a>
			</div>
		</div>
	</div>
	<!-- <div>
		<div id="osiri_upload_idea" class="fab fab-right-bottom">
			<a href="#"><i class="fa fa-check submit" style="font-size:20px;"></i></a>
		</div>
	</div> -->
	<style>
		.item-title.item-label
		{
			white-space: normal;
		}
	</style>
	<div class="page-content">
		<div class="block-title block-title-medium">Fiche innovation</div>
		
        <script id="osiri_submit_idea_template" type="text/template7">
			<div class="list inline-labels no-hairlines-md">
				<ul>
					<li id="osiri_nom" class="item-content item-input">
						<div class="item-inner">
							<div class="item-title item-label">Nom de l'innovation</div>
							<div class="item-input-wrap">
								<input type="text" placeholder="Nom" value="{{ nom }}">
							</div>
						</div>
					</li>
					<li id="osiri_objectifs" class="item-content item-input">
						<div class="item-inner">
							<div class="item-title item-label">Objectif</div>
							<div class="item-input-wrap">
								<input type="text" placeholder="Problématique" value="{{ objectifs }}">
							</div>
						</div>
					</li>
					<li id="osiri_photo" class="item-content item-input">
						<div class="item-inner">
							<div class="item-title item-label">Photo</div>
							<div class="item-input-wrap">
								<a class="link popover-open" href="#" data-popover=".popover-links-photo"><i class="f7-icon material-icons md-only" style="padding-top: 8px;">add_a_photo</i></a>
							</div>
						</div>
						<div class="popover popover-links-photo">
							<div class="popover-inner">
								<div class="list">
									<ul>
										<li><a class="list-button popover-close item-link op2a_vam_option_action_take_photo" href="#">Prendre une photo</a></li>
										<li><a class="list-button popover-close item-link op2a_vam_option_action_add_photo" href="#">Galerie du téléphone</a></li>
									</ul>
								</div>
							</div>
						</div>
						
					</li>
					{{#if photo}}
					<div class="card demo-facebook-card">
						<div class="card-content" style="text-align: center;"> <img src="data:application/octet-stream;base64,{{ photo }}" width="50%"></div>
					</div>
					{{/if}}
				</ul>
			</div>
			<div class="block-title block-title-medium">Informations générales</div>
			<div class="list inline-labels no-hairlines-md">
				<ul>
					<li>
						<div class="item-label" style="white-space: normal; padding-left:16px;">Intérêt :</div>
						<div class="list inline-labels no-hairlines-md">
							<ul style="padding-left: 0px;">
								<li id="osiri_interet_ergonomie" class="item-content item-input">
									<div class="item-media" style="padding-top: 21px;">
										<label class="toggle toggle-init color-blue">
											<input type="checkbox" {{#if interet_ergonomie}}checked{{/if}}>
											<span class="toggle-icon"></span>
										</label>
									</div>
									<div class="item-inner">
										<div class="item-title item-label">Ergonomie</div>
										<div class="item-input-wrap">
											<textarea class="resizable" placeholder="Pourquoi">{{ interet_ergonomie_text }}</textarea>
										</div>
									</div>
								</li>
								<li id="osiri_interet_securite" class="item-content item-input">
									<div class="item-media" style="padding-top: 21px;">
										<label class="toggle toggle-init color-blue">
											<input type="checkbox" {{#if interet_securite}}checked{{/if}}>
											<span class="toggle-icon"></span>
										</label>
									</div>
									<div class="item-inner">
										<div class="item-title item-label">Sécurité</div>
										<div class="item-input-wrap">
											<textarea class="resizable" placeholder="Pourquoi">{{ interet_securite_text }}</textarea>
										</div>
									</div>
								</li>
								<li id="osiri_interet_productivite" class="item-content item-input">
									<div class="item-media" style="padding-top: 21px;">
										<label class="toggle toggle-init color-blue">
											<input type="checkbox" {{#if interet_productivite}}checked{{/if}}>
											<span class="toggle-icon"></span>
										</label>
									</div>
									<div class="item-inner">
										<div class="item-title item-label">Prodéctivité</div>
										<div class="item-input-wrap">
											<textarea class="resizable" placeholder="Pourquoi">{{ interet_productivite_text }}</textarea>
										</div>
									</div>
								</li>
								<li id="osiri_interet_competitivite" class="item-content item-input">
									<div class="item-media" style="padding-top: 21px;">
										<label class="toggle toggle-init color-blue">
											<input type="checkbox" {{#if interet_competitivite}}checked{{/if}}>
											<span class="toggle-icon"></span>
										</label>
									</div>
									<div class="item-inner">
										<div class="item-title item-label">Compétitivité</div>
										<div class="item-input-wrap">
											<textarea class="resizable" placeholder="Pourquoi">{{ interet_competitivite_text }}</textarea>
										</div>
									</div>
								</li>
								<li id="osiri_interet_environnement" class="item-content item-input">
									<div class="item-media" style="padding-top: 21px;">
										<label class="toggle toggle-init color-blue">
											<input type="checkbox" {{#if interet_environnement}}checked{{/if}}>
											<span class="toggle-icon"></span>
										</label>
									</div>
									<div class="item-inner">
										<div class="item-title item-label">Envirenement</div>
										<div class="item-input-wrap">
											<textarea class="resizable" placeholder="Pourquoi">{{ interet_environnement_text }}</textarea>
										</div>
									</div>
								</li>
								<li id="osiri_interet_autre" class="item-content item-input">
									<div class="item-media" style="padding-top: 21px;">
										<label class="toggle toggle-init color-blue">
											<input type="checkbox" {{#if interet_autre}}checked{{/if}}>
											<span class="toggle-icon"></span>
										</label>
									</div>
									<div class="item-inner">
										<div class="item-title item-label">Autre</div>
										<div class="item-input-wrap">
											<textarea class="resizable" placeholder="Pourquoi">{{ interet_autre_text }}</textarea>
										</div>
									</div>
								</li>
							</ul>
						</div>
					</li>
					<li class="item-content item-input">
						<div class="item-inner">
							<div class="item-title item-label">Maturité de l'idée</div>
							<div class="item-input-wrap input-dropdown-wrap">
								<select placeholder="choisir ...">
									<option value="developement">En développement</option>
									<option value="idee">Seulement idée</option>
									<option value="autre">Autre</option>
								</select>
							</div>
						</div>
					</li>
					<li class="item-content item-input">
						<div class="item-inner">
							<div class="item-title item-label">Propriété intellectuelle</div>
							<div class="item-input-wrap input-dropdown-wrap">
								<select placeholder="choisir ...">
									<option value="pas_breveter">Ne pas breveter</option>
									<option value="autre">Autre</option>
								</select>
							</div>
						</div>
					</li>
					<li class="item-content item-input">
						<div class="item-inner">
							<div class="item-title item-label">Produit existant</div>
							<div >
								<label class="toggle toggle-init color-blue">
									<input type="checkbox">
									<span class="toggle-icon"></span>
								</label>
							</div>
						</div>
					</li>
				</ul>
			</div>
			<div class="block-title block-title-medium" style="white-space: normal;">
				<!-- <a class="link popover-open" href="#" data-popover=".popover-links-add-provenance"><i class="f7-icon material-icons md-only" style="padding-top: 8px;">add</i></a>
				<div class="popover popover-links-add-provenance">
					<div class="popover-inner">
						<div class="list">
							<ul>
								<li>
									<a class="smart-select smart-select-init list-button popover-close item-link" data-open-in="popup" data-searchbar="true" data-close-on-select="true" data-searchbar-placeholder="Chercher un collaborateur ...">
										<select name="collaborateur">
											{{#each collaborateurs}}
												<option value="{{id}}" ws_email="{{email}}" ws_nom="{{nom}}" ws_prenom="{{prenom}}">{{ nom }} {{ prenom }}</option>
											{{/each}}
										</select>
										Depuis la base de donnée
									</a>
								</li>
								<li><a class="list-button popover-close sheet-open" href="#" data-sheet=".my-sheet-swipe-to-close">Nouvelle provenance</a></li>
							</ul>
						</div>
					</div>
				</div> -->

				<!-- <a class="item-link smart-select smart-select-init" data-open-in="popup" data-searchbar="true" data-close-on-select="true" data-searchbar-placeholder="Chercher un collaborateur ...">
					<select name="collaborateur">
						{{#each collaborateurs}}
							<option value="{{id}}" ws_email="{{email}}" ws_nom="{{nom}}" ws_prenom="{{prenom}}">{{ nom }} {{ prenom }}</option>
						{{/each}}
					</select>
					<i class="fa fa-plus" style="font-size:20px;"></i>
				</a>
				<a class="sheet-open" href="#" data-sheet=".my-sheet-swipe-to-close"><i class="fa fa-plus" style="font-size:20px;"></i></a> -->
				Provenances
			</div>
			<!-- <div class="block-title block-title-medium" style="white-space: normal;">
				<a class="sheet-open" href="#" data-sheet=".my-sheet-swipe-to-close"><i class="fa fa-plus" style="font-size:20px;"></i></a>
				Provenances
			</div> -->
			
			<div class="list media-list">
				<ul id="osiri_provenance_list">
					{{#if provenance_1_nom}}
					<li id="provenance_1" class="swipeout deleted-callback">
						<div class="item-content swipeout-content">
							<div class="item-inner">
								<div class="item-title-row">
									<div class="item-title"> {{ provenance_1_nom }} {{ provenance_1_prenom }}</div>
									<div class="item-after"> {{ provenance_1_metier }} </div>
								</div>
								<div class="item-subtitle">{{ provenance_1_email }}</div>
							</div>
						</div>
						<div class="swipeout-actions-right">
							<a href="#" class="swipeout-delete">Delete</a>
						</div>
					</li>
					{{/if}}
					{{#if provenance_2_nom}}
					<li id="provenance_2" class="swipeout deleted-callback">
						<div class="item-content swipeout-content">
							<div class="item-inner">
								<div class="item-title-row">
									<div class="item-title"> {{ provenance_2_nom }} {{ provenance_2_prenom }}</div>
									<div class="item-after"> {{ provenance_2_metier }} </div>
								</div>
								<div class="item-subtitle">{{ provenance_2_email }}</div>
							</div>
						</div>
						<div class="swipeout-actions-right">
							<a href="#" class="swipeout-delete">Delete</a>
						</div>
					</li>
					{{/if}}{{#if provenance_3_nom}}
					<li id="provenance_3" class="swipeout deleted-callback">
						<div class="item-content swipeout-content">
							<div class="item-inner">
								<div class="item-title-row">
									<div class="item-title"> {{ provenance_3_nom }} {{ provenance_3_prenom }}</div>
									<div class="item-after"> {{ provenance_3_metier }} </div>
								</div>
								<div class="item-subtitle">{{ provenance_3_email }}</div>
							</div>
						</div>
						<div class="swipeout-actions-right">
							<a href="#" class="swipeout-delete">Delete</a>
						</div>
					</li>
					{{/if}}
				</ul>
				
				<div class="block">
					<div class="row">
						<button class="col button button-fill">
							<a class="item-link smart-select smart-select-init" data-open-in="popup" data-searchbar="true" data-close-on-select="true" data-searchbar-placeholder="Chercher un collaborateur ...">
								<select name="collaborateur">
									{{#each collaborateurs}}
										<option value="{{id}}" ws_email="{{email}}" ws_nom="{{nom}}" ws_prenom="{{prenom}}">{{ nom }} {{ prenom }}</option>
									{{/each}}
								</select>
								Contacts
								<div class="item-title" style="display: none;">Contacts</div>
							</a>
						</button>
						<button class="col button button-fill"><a class="item-link sheet-open" href="#" data-sheet=".my-sheet-swipe-to-close">Autre contact</a></button>
					</div>
				</div>
			</div>
		</script>
		<div class="sheet-modal my-sheet-swipe-to-close" style="height:auto; --f7-sheet-bg-color: #fff;">
			<div class="sheet-modal-inner">
			  <div class="page-content">
				<div class="block">
					<div class="block-title">Provenance</div>
					<div class="list inline-labels no-hairlines-md">
						<ul>
							<li class="item-content item-input">
								<div class="item-inner">
									<div class="item-title item-label">Nom</div>
									<div class="item-input-wrap">
									<input id="nom" type="text" placeholder="Votre nom">
									<span class="input-clear-button"></span>
									</div>
								</div>
							</li>
							<li class="item-content item-input">
								<div class="item-inner">
									<div class="item-title item-label">Prènom</div>
									<div class="item-input-wrap">
									<input id="prenom" type="text" placeholder="Votre prènom">
									<span class="input-clear-button"></span>
									</div>
								</div>
							</li>
							<li class="item-content item-input">
								<div class="item-inner">
									<div class="item-title item-label">E-mail</div>
									<div class="item-input-wrap">
									<input id="email" type="email" placeholder="Votre e-mail">
									<span class="input-clear-button"></span>
									</div>
								</div>
							</li>
							<li class="item-content item-input">
								<div class="item-inner">
									<div class="item-title item-label">Votre métier</div>
									<div class="item-input-wrap">
									<input id="metier" type="text" placeholder="Votre métier | UO/filiale">
									<span class="input-clear-button"></span>
									</div>
								</div>
							</li>
						</ul>
					</div>
				</div>
			  </div>
			</div>
		  </div>
		  <div class="popup popup-provenance">
			<div class="block">
				<div class="block-title">Provenance</div>
				<div class="list inline-labels no-hairlines-md">
					<ul>
						<li class="item-content item-input">
							<div class="item-inner">
								<div class="item-title item-label">Nom</div>
								<div class="item-input-wrap">
								<input id="nom" type="text" placeholder="Votre nom">
								<span class="input-clear-button"></span>
								</div>
							</div>
						</li>
						<li class="item-content item-input">
							<div class="item-inner">
								<div class="item-title item-label">Prènom</div>
								<div class="item-input-wrap">
								<input id="prenom" type="text" placeholder="Votre prènom">
								<span class="input-clear-button"></span>
								</div>
							</div>
						</li>
						<li class="item-content item-input">
							<div class="item-inner">
								<div class="item-title item-label">E-mail</div>
								<div class="item-input-wrap">
								<input id="email" type="email" placeholder="Votre e-mail">
								<span class="input-clear-button"></span>
								</div>
							</div>
						</li>
						<li class="item-content item-input">
							<div class="item-inner">
								<div class="item-title item-label">Votre métier</div>
								<div class="item-input-wrap">
								<input id="metier" type="text" placeholder="Votre métier | UO/filiale">
								<span class="input-clear-button"></span>
								</div>
							</div>
						</li>
					</ul>
				</div>
				<div class="row">
					<button class="col button button-fill popup-close">Ajouter</button>
					<button class="col button button-fill popup-close">Fermer</button>
				</div>
				
			</div>
		</div>
		
		<div id="osiri_submit_idea_content"></div>
	</div>
	<script type="text/javascript" ws_script="page">
		ws_engine.register_page("submit-idea-tab", ws_page.extend(
		{
			custom_tabshow: function(page, event, params)
			{
				var self = this;

				var idee = ws_storage.get_value(OSIRI_STORAGE_KEY_IDEE);
				
				self.template_data = idee ? JSON.parse(idee): {};
				self.data = idee ? JSON.parse(idee): {};

				return self.load_page();
			},

			get_collaborateurs_list: function()
			{
				var self = this;

				return ws_database.collaborateurs.all();
			},
			
			load_page: function()
			{
				var self = this;
				
				self.get_collaborateurs_list().then(function(result)
				{
					self.template_data.collaborateurs = result;

					return self.apply_template(page, "osiri_submit_idea_template", "osiri_submit_idea_content", self.template_data);
				})
				.then(function()
				{
					var option_element = $("#osiri_submit_idea_content");

					// affectation d'une nouvelle image
					option_element.find(".op2a_vam_option_action_take_photo").click(function(e)
					{
						var id = "photo";
						osiri_photos.take_photo(Camera.PictureSourceType.CAMERA).then(function(base64)
						{
							var ul_element = $('#osiri_photo').parent();
							var a = '<div class="card demo-facebook-card">'+
									'<div class="card-content" style="text-align: center;"> <img src="data:application/octet-stream;base64,'+ base64 +'" width="50%"></div>'+
								'</div>';
							ul_element.append(a);
							self.set_value(id, base64);
						});
					});	
					
					// affectation d'une image deja stocker dans la galerie du telephone
					option_element.find(".op2a_vam_option_action_add_photo").click(function(e)
					{
						var id = "photo";
						osiri_photos.take_photo(Camera.PictureSourceType.PHOTOLIBRARY).then(function(base64)
						{
							var ul_element = $('#osiri_photo').parent();
							var a = '<div class="card demo-facebook-card">'+
									'<div class="card-content" style="text-align: center;"> <img src="data:application/octet-stream;base64,'+ base64 +'" width="50%"></div>'+
								'</div>';
							ul_element.append(a);
							self.set_value(id, base64);
						});
					});

					$("#osiri_submit_idea_content input[type='text']").change(function()
					{
						var id = $(this).parent().parent().parent().attr('id').substring(6);
						
						self.set_value(id, $$(this).val(), OSIRI_NOUVELLE_IDEE_OPTION_KEY_TEXT);
					});

					$("#osiri_submit_idea_content textarea").change(function()
					{
						var id = $(this).parent().parent().parent().attr('id').substring(6);
						
						self.set_value(id+"_text", $$(this).val(), OSIRI_NOUVELLE_IDEE_OPTION_KEY_TEXT);
					});

					$("#osiri_submit_idea_content input[type='checkbox']").change(function()
					{
						var id = $(this).parent().parent().parent().attr('id').substring(6);

						self.set_value(id, $(this)[0].checked, OSIRI_NOUVELLE_IDEE_OPTION_KEY_VALUE);
					});
					
					$("#osiri_upload_idea").click(function()
					{
						self.upload();
					});

					var my_sheet = app.sheet.create({
						el: '.my-sheet-swipe-to-close',
						swipeToClose: true,
						backdrop: true,
					});

					$('.my-sheet-swipe-to-close input').change(function()
					{
						var nmbre = $('#osiri_provenance_list').find("li").length + 1;
						var id = $$(this).attr('id');

						self.set_value('provenance_'+nmbre+'_'+id, $$(this).val());
					});

					my_sheet.on('closed', function (sheet)
					{
						var nmbre = $('#osiri_provenance_list').find("li").length + 1;
						if ( nmbre<=3 )
						{
							var a = '<li id="provenance_'+nmbre+'" class="swipeout deleted-callback">'+
							'<div class="item-content swipeout-content">'+
								'<div class="item-inner">'+
									'<div class="item-title-row">'+
										'<div class="item-title">'+ self.data['provenance_'+nmbre+'_nom'] +' '+ self.data['provenance_'+nmbre+'_prenom'] +'</div>'+
										'<div class="item-after">'+ self.data['provenance_'+nmbre+'_metier'] +'</div>'+
									'</div>'+
									'<div class="item-subtitle">'+ self.data['provenance_'+nmbre+'_email'] +'</div>'+
								'</div>'+
							'</div>'+
							'</li>';

							var inputs = $('.my-sheet-swipe-to-close input');
							for ( var i = 0; i<inputs.length; i++)
							{
								inputs[i].value = "";
							}

							if (self.data['provenance_'+nmbre+'_nom'] && self.data['provenance_'+nmbre+'_prenom'] && self.data['provenance_'+nmbre+'_email']) $('#osiri_provenance_list').append(a);
						}
					});

					$(".smart-select select").change(function(e)
					{
						var nmbre = $('#osiri_provenance_list').find("li").length + 1;
						if ( nmbre<=3 )
						{
							var element = $$(this).children();
							for ( var i = 0; i<element.length; i++)
							{
								if (element[i].selected == true) 
								{
									self.set_value('provenance_'+nmbre+'_nom', $(element[i]).attr('ws_nom'));
									self.set_value('provenance_'+nmbre+'_email', $(element[i]).attr('ws_email'));
									self.set_value('provenance_'+nmbre+'_prenom', $(element[i]).attr('ws_prenom'));
									break;
								}
							}

							var a = '<li id="provenance_'+nmbre+'" class="swipeout deleted-callback">'+
							'<div class="item-content swipeout-content">'+
								'<div class="item-inner">'+
									'<div class="item-title-row">'+
										'<div class="item-title">'+ self.data['provenance_'+nmbre+'_nom'] +' '+ self.data['provenance_'+nmbre+'_prenom'] +'</div>'+
										'<div class="item-after">'+ self.data['provenance_'+nmbre+'_metier'] +'</div>'+
									'</div>'+
									'<div class="item-subtitle">'+ self.data['provenance_'+nmbre+'_email'] +'</div>'+
								'</div>'+
							'</div>'+
							'</li>';
							if (self.data['provenance_'+nmbre+'_nom'] && self.data['provenance_'+nmbre+'_prenom'] && self.data['provenance_'+nmbre+'_email']) $('#osiri_provenance_list').append(a);
						}
						
						
					});

					$$('.deleted-callback').on('swipeout:deleted', function ()
					{
						var id = $(this).attr("id");
						
						self.data[id+'_nom'] = undefined;
						self.data[id+'_prenom'] = undefined;
						self.data[id+'_email'] = undefined;
						self.data[id+'_metier'] = undefined;
						
						return self.save();
					});
				});
			},

			set_value : function(property_id, value, prop_change)
			{
				if (this.data[property_id] == undefined) this.data[property_id] = "";
				
				if (this.data[property_id] != value)
				{
					this.data[property_id] = value;
					
					return this.save();
				}
				
				return Promise.resolve();
			},

			save : function()
			{
				var data = JSON.stringify(this.data);
				
                ws_storage.set_value(OSIRI_STORAGE_KEY_IDEE, data);
			},

			upload: function()
			{
				var self = this;

				app.dialog.preloader("Envoie en cours...");
				
				ws_server.depose_idee(self.data).then(function(result)
				{
					ws_storage.set_value(OSIRI_STORAGE_KEY_IDEE, JSON.stringify({}));
					app.dialog.close();
					app.dialog.alert("Lancement d'opération envoyé à OP2A");
				})
				.catch(function(error)
				{
					app.dialog.close();
					app.dialog.alert("Error : " + error);
				});
			},

		}));
	</script>
</div>
		