<div class="page" data-name="submit-idea-tab">
	<div class="navbar">
		<div class="navbar-bg"></div>
		<div class="navbar-inner sliding">
			<div class="title">OSIRI - Idée</div>
		</div>
	</div>
	<div>
		<div id="osiri_upload_idea" class="fab fab-right-bottom">
			<a href="#"><i class="fa fa-check submit" style="font-size:20px;"></i></a>
		</div>
	</div>
	<style>
		.item-title.item-label
		{
			white-space: normal;
		}
	</style>
	<div class="page-content">
		<div class="block-title block-title-medium">Fiche innovation</div>
		
        <script id="osiri_submit_idea_template" type="text/template7">
			<div class="list inline-labels no-hairlines-md">
				<ul>
					<li id="osiri_nom" class="item-content item-input">
						<div class="item-inner">
							<div class="item-title item-label">Nom de l'innovation</div>
							<div class="item-input-wrap">
								<input type="text" placeholder="Nom" value="{{ nom }}">
							</div>
						</div>
					</li>
					<li id="osiri_objectifs" class="item-content item-input">
						<div class="item-inner">
							<div class="item-title item-label">Objectif</div>
							<div class="item-input-wrap">
								<input type="text" placeholder="Problématique" value="{{ objectifs }}">
							</div>
						</div>
					</li>
				</ul>
			</div>
			<div class="block-title block-title-medium">Informations générales</div>
			<div class="list inline-labels no-hairlines-md">
				<ul>
					<li>
						<div class="item-label" style="white-space: normal; padding-left:16px;">Intérêt :</div>
						<div class="list inline-labels no-hairlines-md">
							<ul style="padding-left: 0px;">
								<li id="osiri_interet_ergonomie" class="item-content item-input">
									<div class="item-media" style="padding-top: 21px;">
										<label class="toggle toggle-init color-blue">
											<input type="checkbox" {{#if interet_ergonomie}}checked{{/if}}>
											<span class="toggle-icon"></span>
										</label>
									</div>
									<div class="item-inner">
										<div class="item-title item-label">Ergonomie</div>
										<div class="item-input-wrap">
											<textarea class="resizable" placeholder="Pourquoi">{{ interet_ergonomie_text }}</textarea>
										</div>
									</div>
								</li>
								<li id="osiri_interet_securite" class="item-content item-input">
									<div class="item-media" style="padding-top: 21px;">
										<label class="toggle toggle-init color-blue">
											<input type="checkbox" {{#if interet_securite}}checked{{/if}}>
											<span class="toggle-icon"></span>
										</label>
									</div>
									<div class="item-inner">
										<div class="item-title item-label">Sécurité</div>
										<div class="item-input-wrap">
											<textarea class="resizable" placeholder="Pourquoi">{{ interet_securite_text }}</textarea>
										</div>
									</div>
								</li>
								<li id="osiri_interet_productivite" class="item-content item-input">
									<div class="item-media" style="padding-top: 21px;">
										<label class="toggle toggle-init color-blue">
											<input type="checkbox" {{#if interet_productivite}}checked{{/if}}>
											<span class="toggle-icon"></span>
										</label>
									</div>
									<div class="item-inner">
										<div class="item-title item-label">Prodéctivité</div>
										<div class="item-input-wrap">
											<textarea class="resizable" placeholder="Pourquoi">{{ interet_productivite_text }}</textarea>
										</div>
									</div>
								</li>
								<li id="osiri_interet_competitivite" class="item-content item-input">
									<div class="item-media" style="padding-top: 21px;">
										<label class="toggle toggle-init color-blue">
											<input type="checkbox" {{#if interet_competitivite}}checked{{/if}}>
											<span class="toggle-icon"></span>
										</label>
									</div>
									<div class="item-inner">
										<div class="item-title item-label">Compétitivité</div>
										<div class="item-input-wrap">
											<textarea class="resizable" placeholder="Pourquoi">{{ interet_competitivite_text }}</textarea>
										</div>
									</div>
								</li>
								<li id="osiri_interet_environnement" class="item-content item-input">
									<div class="item-media" style="padding-top: 21px;">
										<label class="toggle toggle-init color-blue">
											<input type="checkbox" {{#if interet_environnement}}checked{{/if}}>
											<span class="toggle-icon"></span>
										</label>
									</div>
									<div class="item-inner">
										<div class="item-title item-label">Envirenement</div>
										<div class="item-input-wrap">
											<textarea class="resizable" placeholder="Pourquoi">{{ interet_environnement_text }}</textarea>
										</div>
									</div>
								</li>
								<li id="osiri_interet_autre" class="item-content item-input">
									<div class="item-media" style="padding-top: 21px;">
										<label class="toggle toggle-init color-blue">
											<input type="checkbox" {{#if interet_autre}}checked{{/if}}>
											<span class="toggle-icon"></span>
										</label>
									</div>
									<div class="item-inner">
										<div class="item-title item-label">Autre</div>
										<div class="item-input-wrap">
											<textarea class="resizable" placeholder="Pourquoi">{{ interet_autre_text }}</textarea>
										</div>
									</div>
								</li>
							</ul>
						</div>
					</li>
					<li class="item-content item-input">
						<div class="item-inner">
							<div class="item-title item-label">Maturité de l'idée</div>
							<div class="item-input-wrap input-dropdown-wrap">
								<select placeholder="choisir ...">
									<option value="developement">En développement</option>
									<option value="idee">seulement idée</option>
									<option value="autre">autre</option>
								</select>
							</div>
						</div>
					</li>
					<li class="item-content item-input">
						<div class="item-inner">
							<div class="item-title item-label">Propriété intellectuelle</div>
							<div class="item-input-wrap input-dropdown-wrap">
								<select placeholder="choisir ...">
									<option value="pas_breveter">Ne pas breveter</option>
									<option value="autre">autre</option>
								</select>
							</div>
						</div>
					</li>
					<li class="item-content item-input">
						<div class="item-inner">
							<div class="item-title item-label">Produit existant</div>
							<div >
								<label class="toggle toggle-init color-blue">
									<input type="checkbox">
									<span class="toggle-icon"></span>
								</label>
							</div>
						</div>
					</li>
				</ul>
			</div>
			
			<div class="block-title block-title-medium" style="white-space: normal;">
				<a class="item-link smart-select smart-select-init" data-open-in="popup" data-searchbar="true" data-searchbar-placeholder="Chercher un collaborateur ...">
					<select name="collaborateur">
						<option value="honda" selected>Honda</option>
						<option value="lexus">Lexus</option>
						<option value="mazda">Mazda</option>
						<option value="nissan">Nissan</option>
						<option value="toyota">Toyota</option>
						<option><a class="sheet-open" href="#" data-sheet=".my-sheet-swipe-to-close">Ajouter un collaborateur</a></option>
						<div class="block searchbar-not-found">
							<div class="block-inner">Nothing found</div>
						  </div>
					</select>
					<i class="fa fa-plus" style="font-size:20px;"></i>
				</a>
				<a class="sheet-open" href="#" data-sheet=".my-sheet-swipe-to-close"><i class="fa fa-plus" style="font-size:20px;"></i></a>
				<!-- <a class="popup-open" href="#" data-popup=".popup-provenance" ><i class="fa fa-plus" style="font-size:20px;"></i></a> -->
				Provenances
			</div>
			<!-- <div class="block-title block-title-medium" style="white-space: normal;">
				<a class="sheet-open" href="#" data-sheet=".my-sheet-swipe-to-close"><i class="fa fa-plus" style="font-size:20px;"></i></a>
				Provenances
			</div> -->
			
			<div class="list media-list">
				<ul id="osiri_provenance_list">
					{{#if provenance_1_nom}}
					<li id="provenance_1" class="swipeout deleted-callback">
						<div class="item-content swipeout-content">
							<div class="item-inner">
								<div class="item-title-row">
									<div class="item-title"> {{ provenance_1_nom }} {{ provenance_1_prenom }}</div>
									<div class="item-after"> {{ provenance_1_metier }} </div>
								</div>
								<div class="item-subtitle">{{ provenance_1_email }}</div>
							</div>
						</div>
						<div class="swipeout-actions-right">
							<a href="#" class="swipeout-delete">Delete</a>
						</div>
					</li>
					{{/if}}
					{{#if provenance_2_nom}}
					<li id="provenance_2" class="swipeout deleted-callback">
						<div class="item-content swipeout-content">
							<div class="item-inner">
								<div class="item-title-row">
									<div class="item-title"> {{ provenance_2_nom }} {{ provenance_2_prenom }}</div>
									<div class="item-after"> {{ provenance_2_metier }} </div>
								</div>
								<div class="item-subtitle">{{ provenance_2_email }}</div>
							</div>
						</div>
						<div class="swipeout-actions-right">
							<a href="#" class="swipeout-delete">Delete</a>
						</div>
					</li>
					{{/if}}{{#if provenance_3_nom}}
					<li id="provenance_3" class="swipeout deleted-callback">
						<div class="item-content swipeout-content">
							<div class="item-inner">
								<div class="item-title-row">
									<div class="item-title"> {{ provenance_3_nom }} {{ provenance_3_prenom }}</div>
									<div class="item-after"> {{ provenance_3_metier }} </div>
								</div>
								<div class="item-subtitle">{{ provenance_3_email }}</div>
							</div>
						</div>
						<div class="swipeout-actions-right">
							<a href="#" class="swipeout-delete">Delete</a>
						</div>
					</li>
					{{/if}}
				</ul>
			</div>
		</script>
		<div class="sheet-modal my-sheet-swipe-to-close" style="height:auto; --f7-sheet-bg-color: #fff;">
			<div class="sheet-modal-inner">
			  <div class="page-content">
				<div class="block">
					<div class="block-title">Provenance</div>
					<div class="list inline-labels no-hairlines-md">
						<ul>
							<li class="item-content item-input">
								<div class="item-inner">
									<div class="item-title item-label">Nom</div>
									<div class="item-input-wrap">
									<input id="nom" type="text" placeholder="Votre nom">
									<span class="input-clear-button"></span>
									</div>
								</div>
							</li>
							<li class="item-content item-input">
								<div class="item-inner">
									<div class="item-title item-label">Prènom</div>
									<div class="item-input-wrap">
									<input id="prenom" type="text" placeholder="Votre prènom">
									<span class="input-clear-button"></span>
									</div>
								</div>
							</li>
							<li class="item-content item-input">
								<div class="item-inner">
									<div class="item-title item-label">E-mail</div>
									<div class="item-input-wrap">
									<input id="email" type="email" placeholder="Votre e-mail">
									<span class="input-clear-button"></span>
									</div>
								</div>
							</li>
							<li class="item-content item-input">
								<div class="item-inner">
									<div class="item-title item-label">Votre métier</div>
									<div class="item-input-wrap">
									<input id="metier" type="text" placeholder="Votre métier | UO/filiale">
									<span class="input-clear-button"></span>
									</div>
								</div>
							</li>
						</ul>
					</div>
				</div>
			  </div>
			</div>
		  </div>
		  <div class="popup popup-provenance">
			<div class="block">
				<div class="block-title">Provenance</div>
				<div class="list inline-labels no-hairlines-md">
					<ul>
						<li class="item-content item-input">
							<div class="item-inner">
								<div class="item-title item-label">Nom</div>
								<div class="item-input-wrap">
								<input id="nom" type="text" placeholder="Votre nom">
								<span class="input-clear-button"></span>
								</div>
							</div>
						</li>
						<li class="item-content item-input">
							<div class="item-inner">
								<div class="item-title item-label">Prènom</div>
								<div class="item-input-wrap">
								<input id="prenom" type="text" placeholder="Votre prènom">
								<span class="input-clear-button"></span>
								</div>
							</div>
						</li>
						<li class="item-content item-input">
							<div class="item-inner">
								<div class="item-title item-label">E-mail</div>
								<div class="item-input-wrap">
								<input id="email" type="email" placeholder="Votre e-mail">
								<span class="input-clear-button"></span>
								</div>
							</div>
						</li>
						<li class="item-content item-input">
							<div class="item-inner">
								<div class="item-title item-label">Votre métier</div>
								<div class="item-input-wrap">
								<input id="metier" type="text" placeholder="Votre métier | UO/filiale">
								<span class="input-clear-button"></span>
								</div>
							</div>
						</li>
					</ul>
				</div>
				<div class="row">
					<button class="col button button-fill popup-close">Ajouter</button>
					<button class="col button button-fill popup-close">Fermer</button>
				</div>
				
			</div>
		</div>
		
		<div id="osiri_submit_idea_content"></div>
	</div>
	<script type="text/javascript" ws_script="page">
		ws_engine.register_page("submit-idea-tab", ws_page.extend(
		{
			custom_tabshow: function(page, event, params)
			{
				var self = this;

                var idee = ws_storage.get_value(OSIRI_STORAGE_KEY_IDEE);
				self.data = idee ? JSON.parse(idee): {};
				self.data[OSIRI_NOUVELLE_IDEE_PROPERTY_PHOTO] = "base64";

				return self.load_page();
			},
			
			load_page: function()
			{
				var self = this;
				
				return self.apply_template(page, "osiri_submit_idea_template", "osiri_submit_idea_content", self.data).then(function()
				{
					$("#osiri_submit_idea_content input[type='text']").change(function()
					{
						var id = $(this).parent().parent().parent().attr('id').substring(6);
						
						self.set_value(id, $$(this).val(), OSIRI_NOUVELLE_IDEE_OPTION_KEY_TEXT);
					});

					$("#osiri_submit_idea_content textarea").change(function()
					{
						var id = $(this).parent().parent().parent().attr('id').substring(6);
						
						self.set_value(id+"_text", $$(this).val(), OSIRI_NOUVELLE_IDEE_OPTION_KEY_TEXT);
					});

					$("#osiri_submit_idea_content input[type='checkbox']").change(function()
					{
						var id = $(this).parent().parent().parent().attr('id').substring(6);

						self.set_value(id, $(this)[0].checked, OSIRI_NOUVELLE_IDEE_OPTION_KEY_VALUE);
					});
					
					$("#osiri_upload_idea").click(function()
					{
						self.upload();
					});

					var my_sheet = app.sheet.create({
						el: '.my-sheet-swipe-to-close',
						swipeToClose: true,
						backdrop: true,
					});

					$('.my-sheet-swipe-to-close input').change(function()
					{
						var nmbre = $('#osiri_provenance_list').find("li").length + 1;
						var id = $$(this).attr('id');

						self.set_value('provenance_'+nmbre+'_'+id, $$(this).val());
					});

					my_sheet.on('closed', function (sheet)
					{
						var nmbre = $('#osiri_provenance_list').find("li").length + 1;
						var a = '<li>'+
						'<div href="#" class="item-content">'+
							'<div class="item-inner">'+
								'<div class="item-title-row">'+
									'<div class="item-title">'+ self.data['provenance_'+nmbre+'_nom'] +' '+ self.data['provenance_'+nmbre+'_prenom'] +'</div>'+
									'<div class="item-after">'+ self.data['provenance_'+nmbre+'_metier'] +'</div>'+
								'</div>'+
								'<div class="item-subtitle">'+ self.data['provenance_'+nmbre+'_email'] +'</div>'+
							'</div>'+
						'</div>'+
						'</li>';
						var inputs = $('.my-sheet-swipe-to-close input');

						for ( var i = 0; i<inputs.length; i++)
						{
							inputs[i].value = "";
						}

						if (self.data['provenance_'+nmbre+'_nom'] && self.data['provenance_'+nmbre+'_prenom'] && self.data['provenance_'+nmbre+'_email']) $('#osiri_provenance_list').append(a);
					});

					$$('.deleted-callback').on('swipeout:deleted', function ()
					{
						var id = $(this).attr("id");
						
						self.data[id+'_nom'] = undefined;
						self.data[id+'_prenom'] = undefined;
						self.data[id+'_email'] = undefined;
						self.data[id+'_metier'] = undefined;
						
						return self.save();
					});
				});
			},

			set_value : function(property_id, value, prop_change)
			{
				if (this.data[property_id] == undefined) this.data[property_id] = "";
				
				if (this.data[property_id] != value)
				{
					this.data[property_id] = value;
					
					return this.save();
				}
				
				return Promise.resolve();
			},

			save : function()
			{
				var data = JSON.stringify(this.data);
				
                ws_storage.set_value(OSIRI_STORAGE_KEY_IDEE, data);
			},

			upload: function()
			{
				var self = this;

				app.dialog.preloader("Envoie en cours...");
				
				ws_server.depose_idee(self.data).then(function(result)
				{
					ws_storage.set_value(OSIRI_STORAGE_KEY_IDEE, JSON.stringify({}));
					app.dialog.close();
					app.dialog.alert("Lancement d'opération envoyé à OP2A");
				})
				.catch(function(error)
				{
					app.dialog.close();
					app.dialog.alert("Error : " + error);
				});
			},

		}));
	</script>
</div>
		