<div class="page" data-name="submit-idea-tab">
	<div class="navbar">
		<div class="navbar-bg"></div>
		<div class="navbar-inner sliding">
			<div class="left" style="display: none;">
				<a href="#" class="link back">
				<i class="icon icon-back"></i>
				<span class="if-not-md">Back</span>
				</a>
			</div>
			<div class="title">OSIRI - Idée</div>
			<div class="right">
				<!-- <a href="#" id="osiri_upload_idea" class="link icon-only"><i class="fa fa-check" style="font-size:20px;"></i></a> -->
				<a id="idee_list" href="/nouvelle_idee_list/" class="link icon-only"><i class="fa fa-list" style="font-size:20px;"></i></a>
				<a id="upload_idea" href="#" class="link icon-only" style="display: none;"><i class="fa fa-paper-plane" style="font-size:20px;"></i></a>
			</div>
		</div>
	</div>
	<!-- <div>
		<div id="osiri_upload_idea" class="fab fab-right-bottom">
			<a href="#"><i class="fa fa-check" style="font-size:20px;"></i></a>
		</div>
	</div> -->
	<div class="fab fab-right-bottom">
		<a href="#">
			<i class="fa fa-arrow-up" style="font-size:20px;"></i>
			<i class="fa fa-arrow-down" style="font-size:20px;"></i>
		</a>
		
		<!-- FAB speed dial actions with labels -->
		<div class="fab-buttons fab-buttons-top">
			<a id="osiri_save_idea" href="#" class="fab-label-button">
				<i class="fa fa-save" style="font-size:20px;"></i>
				<span class="fab-label">Enregistrer</span>
			</a>
			<a id="osiri_upload_idea" href="#" class="fab-label-button">
				<i class="fa fa-paper-plane" style="font-size:20px;"></i>
				<span class="fab-label">Envoyer</span>
			</a>
		</div>
	</div>
	<style>
		.item-title.item-label
		{
			white-space: normal;
		}
	</style>
	<div class="page-content" style="margin-bottom: 20px;">
		<div class="block-title block-title-medium">Fiche innovation</div>
		
        <script id="osiri_submit_idea_template" type="text/template7">
			<div class="list inline-labels no-hairlines-md">
				<ul>
					<li id="osiri_nom" class="item-content item-input">
						<div class="item-inner">
							<div class="item-title item-label">Nom de l'innovation</div>
							<div class="item-input-wrap">
								<input type="text" placeholder="Nom" value="{{ nom }}">
							</div>
						</div>
					</li>
					<li id="osiri_objectifs" class="item-content item-input">
						<div class="item-inner">
							<div class="item-title item-label">Objectif</div>
							<div class="item-input-wrap">
								<textarea class="resizable" placeholder="Problématique">{{ objectifs_text }}</textarea>
							</div>
						</div>
					</li>
					<li id="osiri_photo" class="item-content item-input">
						<div class="item-inner">
							<div class="item-title item-label">Photo</div>
							<div class="item-input-wrap">
								<a class="link popover-open" href="#" data-popover=".popover-links-photo"><i class="f7-icon material-icons md-only" style="padding-top: 8px;">add_a_photo</i></a>
							</div>
						</div>
						<div class="popover popover-links-photo">
							<div class="popover-inner">
								<div class="list">
									<ul>
										<li><a class="list-button popover-close item-link op2a_vam_option_action_take_photo" href="#">Prendre une photo</a></li>
										<li><a class="list-button popover-close item-link op2a_vam_option_action_add_photo" href="#">Galerie du téléphone</a></li>
									</ul>
								</div>
							</div>
						</div>
						
					</li>
					{{#if photo}}
					<div class="card demo-facebook-card">
						<div class="card-content" style="text-align: center;"> <img src="data:application/octet-stream;base64,{{ photo }}" width="50%"></div>
					</div>
					{{/if}}
				</ul>
			</div>
			<div class="block-title block-title-medium">Informations générales</div>
			<div class="list inline-labels no-hairlines-md">
				<ul>
					<li>
						<div class="item-label" style="white-space: normal; padding-left:16px;">Intérêt :</div>
						<div class="list inline-labels no-hairlines-md">
							<ul style="padding-left: 0px;">
								<li id="osiri_interet_ergonomie" class="item-content item-input">
									<div class="item-media" style="padding-top: 21px;">
										<label class="toggle toggle-init">
											<input type="checkbox" {{#if interet_ergonomie}}checked{{/if}}>
											<span class="toggle-icon"></span>
										</label>
									</div>
									<div class="item-inner">
										<div class="item-title item-label">Ergonomie</div>
										<div class="item-input-wrap">
											<textarea class="resizable" placeholder="Pourquoi">{{ interet_ergonomie_text }}</textarea>
										</div>
									</div>
								</li>
								<li id="osiri_interet_securite" class="item-content item-input">
									<div class="item-media" style="padding-top: 21px;">
										<label class="toggle toggle-init">
											<input type="checkbox" {{#if interet_securite}}checked{{/if}}>
											<span class="toggle-icon"></span>
										</label>
									</div>
									<div class="item-inner">
										<div class="item-title item-label">Sécurité</div>
										<div class="item-input-wrap">
											<textarea class="resizable" placeholder="Pourquoi">{{ interet_securite_text }}</textarea>
										</div>
									</div>
								</li>
								<li id="osiri_interet_productivite" class="item-content item-input">
									<div class="item-media" style="padding-top: 21px;">
										<label class="toggle toggle-init">
											<input type="checkbox" {{#if interet_productivite}}checked{{/if}}>
											<span class="toggle-icon"></span>
										</label>
									</div>
									<div class="item-inner">
										<div class="item-title item-label">Productivité</div>
										<div class="item-input-wrap">
											<textarea class="resizable" placeholder="Pourquoi">{{ interet_productivite_text }}</textarea>
										</div>
									</div>
								</li>
								<li id="osiri_interet_competitivite" class="item-content item-input">
									<div class="item-media" style="padding-top: 21px;">
										<label class="toggle toggle-init">
											<input type="checkbox" {{#if interet_competitivite}}checked{{/if}}>
											<span class="toggle-icon"></span>
										</label>
									</div>
									<div class="item-inner">
										<div class="item-title item-label">Compétitivité</div>
										<div class="item-input-wrap">
											<textarea class="resizable" placeholder="Pourquoi">{{ interet_competitivite_text }}</textarea>
										</div>
									</div>
								</li>
								<li id="osiri_interet_environnement" class="item-content item-input">
									<div class="item-media" style="padding-top: 21px;">
										<label class="toggle toggle-init">
											<input type="checkbox" {{#if interet_environnement}}checked{{/if}}>
											<span class="toggle-icon"></span>
										</label>
									</div>
									<div class="item-inner">
										<div class="item-title item-label">Environnement</div>
										<div class="item-input-wrap">
											<textarea class="resizable" placeholder="Pourquoi">{{ interet_environnement_text }}</textarea>
										</div>
									</div>
								</li>
								<li id="osiri_interet_autre" class="item-content item-input">
									<div class="item-media" style="padding-top: 21px;">
										<label class="toggle toggle-init">
											<input type="checkbox" {{#if interet_autre}}checked{{/if}}>
											<span class="toggle-icon"></span>
										</label>
									</div>
									<div class="item-inner">
										<div class="item-title item-label">Autre</div>
										<div class="item-input-wrap">
											<textarea class="resizable" placeholder="Pourquoi">{{ interet_autre_text }}</textarea>
										</div>
									</div>
								</li>
							</ul>
						</div>
					</li>
					<li class="item-content item-input">
						<div class="item-inner" id="osiri_maturite">
							<div class="item-title item-label">Maturité de l'idée</div>
							<div class="item-input-wrap input-dropdown-wrap">
								<select class="property" placeholder="choisir ...">
									<option value="idee_a_developement" {{#js_if "this.maturite == 'idee_a_developement'"}}selected{{/js_if}}>Idée à développer</option>
									<option value="en_developement" {{#js_if "this.maturite == 'en_developement'"}}selected{{/js_if}}>En développement</option>
									<option value="realise_test" {{#js_if "this.maturite == 'realise_test'"}}selected{{/js_if}}>Réalisé, en test</option>
									<option value="realise_deploiemenet" {{#js_if "this.maturite == 'realise_deploiemenet'"}}selected{{/js_if}}>Réalisé, en déploiement</option>
								</select>
							</div>
						</div>
					</li>
					<li class="item-content item-input">
						<div class="item-inner" id="osiri_propriete_intellectuelle">
							<div class="item-title item-label">Propriété intellectuelle</div>
							<div class="item-input-wrap input-dropdown-wrap">
								<select class="property" placeholder="choisir ...">
									<option value="a_breveter" {{#js_if "this.propriete_intellectuelle == 'a_breveter'"}}selected{{/js_if}}>À breveter</option>
									<option value="ne_pas_breveter" {{#js_if "this.propriete_intellectuelle == 'ne_pas_breveter'"}}selected{{/js_if}}>Ne pas breveter</option>
								</select>
							</div>
						</div>
					</li>
					<li class="item-content item-input">
						<div class="item-inner" id="osiri_produit_existant">
							<div class="item-title item-label">Produit existant</div>
							<div>
								<label class="toggle toggle-init">
									<input type="checkbox" {{#if produit_existant}}checked{{/if}}>
									<span class="toggle-icon"></span>
								</label>
							</div>
						</div>
					</li>
				</ul>
			</div>
			<div class="block-title block-title-medium" style="white-space: normal;">
				<!-- <a class="link popover-open" href="#" data-popover=".popover-links-add-provenance"><i class="f7-icon material-icons md-only" style="padding-top: 8px;">add</i></a>
				<div class="popover popover-links-add-provenance">
					<div class="popover-inner">
						<div class="list">
							<ul>
								<li>
									<a class="smart-select smart-select-init list-button popover-close item-link" data-open-in="popup" data-searchbar="true" data-close-on-select="true" data-searchbar-placeholder="Chercher un collaborateur ...">
										<select name="collaborateur">
											{{#each collaborateurs}}
												<option value="{{id}}" ws_email="{{email}}" ws_nom="{{nom}}" ws_prenom="{{prenom}}" ws_entite="{{entite}}" ws_metier="{{metier}}">{{ nom }} {{ prenom }}</option>
											{{/each}}
										</select>
										Depuis la base de donnée
									</a>
								</li>
								<li><a class="list-button popover-close sheet-open" href="#" data-sheet=".my-sheet-swipe-to-close">Nouvelle provenance</a></li>
							</ul>
						</div>
					</div>
				</div> -->

				<!-- <a class="item-link smart-select smart-select-init" data-open-in="popup" data-searchbar="true" data-close-on-select="true" data-searchbar-placeholder="Chercher un collaborateur ...">
					<select name="collaborateur">
						{{#each collaborateurs}}
							<option value="{{id}}" ws_email="{{email}}" ws_nom="{{nom}}" ws_prenom="{{prenom}}">{{ nom }} {{ prenom }}</option>
						{{/each}}
					</select>
					<i class="fa fa-plus" style="font-size:20px;"></i>
				</a>
				<a class="sheet-open" href="#" data-sheet=".my-sheet-swipe-to-close"><i class="fa fa-plus" style="font-size:20px;"></i></a> -->
				Provenances
			</div>
			<!-- <div class="block-title block-title-medium" style="white-space: normal;">
				<a class="sheet-open" href="#" data-sheet=".my-sheet-swipe-to-close"><i class="fa fa-plus" style="font-size:20px;"></i></a>
				Provenances
			</div> -->
			
			<div class="list media-list">
				<ul id="osiri_provenance_list">
					{{#if provenance_1_nom}}
					<li id="provenance_1" class="swipeout deleted-callback">
						<div class="item-content swipeout-content">
							<div class="item-inner">
								<div class="item-title-row">
									<div class="item-title"> {{ provenance_1_nom }} {{ provenance_1_prenom }}</div>
									<div class="item-after"> {{ provenance_1_metier }} {{ provenance_1_entite }}</div>
								</div>
								<div class="item-subtitle">{{ provenance_1_email }}</div>
							</div>
						</div>
						<div class="swipeout-actions-right">
							<a href="#" class="swipeout-delete">Delete</a>
						</div>
					</li>
					{{/if}}
					{{#if provenance_2_nom}}
					<li id="provenance_2" class="swipeout deleted-callback">
						<div class="item-content swipeout-content">
							<div class="item-inner">
								<div class="item-title-row">
									<div class="item-title"> {{ provenance_2_nom }} {{ provenance_2_prenom }}</div>
									<div class="item-after"> {{ provenance_2_metier }} {{ provenance_2_entite }}</div>
								</div>
								<div class="item-subtitle">{{ provenance_2_email }}</div>
							</div>
						</div>
						<div class="swipeout-actions-right">
							<a href="#" class="swipeout-delete">Delete</a>
						</div>
					</li>
					{{/if}}{{#if provenance_3_nom}}
					<li id="provenance_3" class="swipeout deleted-callback">
						<div class="item-content swipeout-content">
							<div class="item-inner">
								<div class="item-title-row">
									<div class="item-title"> {{ provenance_3_nom }} {{ provenance_3_prenom }}</div>
									<div class="item-after"> {{ provenance_3_metier }} {{ provenance_3_entite }}</div>
								</div>
								<div class="item-subtitle">{{ provenance_3_email }}</div>
							</div>
						</div>
						<div class="swipeout-actions-right">
							<a href="#" class="swipeout-delete">Delete</a>
						</div>
					</li>
					{{/if}}
				</ul>
				
				<div class="block">
					<div class="row">
						<button class="col button button-fill">
							<a class="item-link smart-select smart-select-init" data-open-in="popup" data-searchbar="true" data-close-on-select="true" data-searchbar-placeholder="Chercher un collaborateur ...">
								<select name="collaborateur">
									{{#each collaborateurs}}
										<option value="{{id}}" ws_email="{{email}}" ws_nom="{{nom}}" ws_prenom="{{prenom}}" ws_entite="{{entite}}" ws_metier="{{metier}}">{{ nom }} {{ prenom }}</option>
									{{/each}}
								</select>
								Contacts
								<div class="item-title" style="display: none;">Contacts</div>
							</a>
						</button>
						<button class="col button button-fill"><a class="item-link sheet-open" href="#" data-sheet=".my-sheet">Autre contact</a></button>
					</div>
				</div>
			</div>
		</script>
		<div class="sheet-modal my-sheet" style="height:auto; --f7-sheet-bg-color: #fff;">
			<div class="toolbar">
				<div class="toolbar-inner">
					<div class="left"><a class="link sheet-close" href="#">Annuler</a></div>
					<div class="right"><a id="add_provenance" class="link sheet-close" href="#">Ajouter</a></div>
				</div>
			</div>
			<div class="sheet-modal-inner">
			  <div class="page-content">
				<div class="block">
					<div class="block-title">Provenance</div>
					<div class="list inline-labels no-hairlines-md">
						<ul>
							<li class="item-content item-input">
								<div class="item-inner">
									<div class="item-title item-label">Nom</div>
									<div class="item-input-wrap">
									<input id="nom" type="text" placeholder="Votre nom">
									<span class="input-clear-button"></span>
									</div>
								</div>
							</li>
							<li class="item-content item-input">
								<div class="item-inner">
									<div class="item-title item-label">Prènom</div>
									<div class="item-input-wrap">
									<input id="prenom" type="text" placeholder="Votre prènom">
									<span class="input-clear-button"></span>
									</div>
								</div>
							</li>
							<li class="item-content item-input">
								<div class="item-inner">
									<div class="item-title item-label">E-mail</div>
									<div class="item-input-wrap">
									<input id="email" type="email" placeholder="Votre e-mail">
									<span class="input-clear-button"></span>
									</div>
								</div>
							</li>
							<li class="item-content item-input">
								<div class="item-inner">
									<div class="item-title item-label">Métier</div>
									<div class="item-input-wrap">
										<select id="metier" placeholder="choisir ...">
											<option value="undefined">...</option>
											<option value="MATERIEL">MATERIEL</option>
											<option value="R&D - DD">R&D - DD</option>
											<option value="PREVENTION SANTE SECURITE">PREVENTION SANTE SECURITE</option>
											<option value="METHODE">METHODE</option>
											<option value="METHODE">TRAVAUX</option>
											<option value="AUTRE">AUTRE</option>
										</select>
									</div>
								</div>
							</li>
							<li class="item-content item-input">
								<div class="item-inner">
									<div class="item-title item-label">Entité</div>
									<div class="item-input-wrap">
										<select id="entite" placeholder="choisir ...">
											<option value="undefined">...</option>
											<option value="BYCN">BYCN</option>
											<option value="BYUK">BYUK</option>
											<option value="LOSINGER MARAZZI">LOSINGER MARAZZI</option>
											<option value="BBI">BBI</option>
											<option value="BBFE">BBFE</option>
											<option value="BBFE / HAS">BBFE / HAS</option>
											<option value="BBFE / BZ">BBFE / BZ</option>
											<option value="BBFE / REP">BBFE / REP</option>
											<option value="BBFE / OPB">BBFE / OPB</option>
											<option value="BBFE / CPI">BBFE / CPI</option>
											<option value="BBFE / HAR">BBFE / HAR</option>
											<option value="BBFE / BBSE">BBFE / BBSE</option>
											<option value="BBFE / BBCSO">BBFE / BBCSO</option>
											<option value="BBFE / BBGO">BBFE / BBGO</option>
											<option value="BBFE / BBNE">BBFE / BBNE</option>
											<option value="BYTP">BYTP</option>
											<option value="BYTP / RF">BYTP / RF</option>
											<option value="BYTP / RP">BYTP / RP</option>
											<option value="BCM">BCM</option>
											<option value="BCM / MATERIEL">BCM / MATERIEL</option>
											<option value="BCM / DISTRIMO">BCM / DISTRIMO</option>
											<option value="BYES">BYES</option>
										</select>
										<!-- <input id="entite" type="text" placeholder="Votre UO/entite">
										<span class="input-clear-button"></span> -->
									</div>
								</div>
							</li>
						</ul>
					</div>
				</div>
			  </div>
			</div>
		  </div>
		
		<div id="osiri_submit_idea_content"></div>
	</div>
	<script type="text/javascript" ws_script="page">
		ws_engine.register_page("submit-idea-tab", ws_page.extend(
		{
			custom_init: function(page, event, params)
			{
				var self = this;
				
				self.id = self.params.id;
				self.is_new = (self.id == undefined);

				if (!self.is_new) 
				{
					$(".left").css('display', 'block');
					$("#idee_list").css('display', 'none');
					$(".fab").css('display', 'none');
					$("#upload_idea").css('display', 'block');
					
					ws_database.nouvelle_idees.get_with_id(self.id).then(function(result)
					{
						self.idee = result;
						self.data = JSON.parse(result.data);
						self.template_data = JSON.parse(result.data);
					});
				}
				else
				{
					self.data = {};
					self.template_data = {};
				}
						
				return self.load_page().then(function()
				{
					self.events();
				});
			},

			custom_tabshow: function(page, event, params)
			{
				var self = this;
				
				self.id = self.params.id;
				self.is_new = (self.id == undefined);

				if (!self.is_new) 
				{
					$(".left").css('display', 'block');
					$("#idee_list").css('display', 'none');
					$(".fab").css('display', 'none');
					$("#upload_idea").css('display', 'block');
					
					ws_database.nouvelle_idees.get_with_id(self.id).then(function(result)
					{
						self.idee = result;
						self.data = JSON.parse(result.data);
						self.template_data = JSON.parse(result.data);
					});
				}
				else
				{
					self.data = {};
					self.template_data = {};
				}
						
				return self.load_page().then(function()
				{
					self.events();
				});
			},

			get_collaborateurs_list: function()
			{
				var self = this;

				return ws_database.collaborateurs.all();
			},
			
			load_page: function()
			{
				var self = this;
				
				return self.get_collaborateurs_list().then(function(result)
				{
					self.template_data.collaborateurs = result;

					self.template_data.collaborateurs.sort((a,b) => (a[OSIRI_COLLABORATEUR_PROPERTY_LASTNAME] > b[OSIRI_COLLABORATEUR_PROPERTY_LASTNAME]) ? 1 : (a[OSIRI_COLLABORATEUR_PROPERTY_LASTNAME] < b[OSIRI_COLLABORATEUR_PROPERTY_LASTNAME] ? -1 : 0 ));

					return self.apply_template(page, "osiri_submit_idea_template", "osiri_submit_idea_content", self.template_data);
				});
			},

			events : function()
			{
				var self = this;
				var option_element = $("#osiri_submit_idea_content");

				// affectation d'une nouvelle image
				option_element.find(".op2a_vam_option_action_take_photo").click(function(e)
				{
					var id = "photo";
					return osiri_photos.take_photo(Camera.PictureSourceType.CAMERA).then(function(base64)
					{
						var ul_element = $('#osiri_photo').parent();
						$('#osiri_photo').parent().find('.card').remove();

						var a = '<div class="card demo-facebook-card">'+
								'<div class="card-content" style="text-align: center;"> <img src="data:application/octet-stream;base64,'+ base64 +'" width="50%"></div>'+
							'</div>';
						ul_element.append(a);
						self.set_value(id, base64);
					});
				});	

				// affectation d'une image deja stocker dans la galerie du telephone
				option_element.find(".op2a_vam_option_action_add_photo").click(function(e)
				{
					var id = "photo";
					return osiri_photos.take_photo(Camera.PictureSourceType.PHOTOLIBRARY).then(function(base64)
					{
						var ul_element = $('#osiri_photo').parent();
						$('#osiri_photo').parent().find('.card').remove();

						var a = '<div class="card demo-facebook-card">'+
								'<div class="card-content" style="text-align: center;"> <img src="data:application/octet-stream;base64,'+ base64 +'" width="50%"></div>'+
							'</div>';
						ul_element.append(a);
						self.set_value(id, base64);
					});
				});

				$("#osiri_submit_idea_content input[type='text']").change(function()
				{
					var id = $(this).parent().parent().parent().attr('id').substring(6);

					self.set_value(id, $$(this).val(), OSIRI_NOUVELLE_IDEE_OPTION_KEY_TEXT);
				});

				$("#osiri_submit_idea_content textarea").change(function()
				{
					var id = $(this).parent().parent().parent().attr('id').substring(6);
					
					self.set_value(id+"_text", $$(this).val(), OSIRI_NOUVELLE_IDEE_OPTION_KEY_TEXT);
				});

				$("#osiri_submit_idea_content input[type='checkbox']").change(function()
				{
					var id = $(this).parent().parent().parent().attr('id').substring(6);

					self.set_value(id, $(this)[0].checked, OSIRI_NOUVELLE_IDEE_OPTION_KEY_VALUE);
				});

				$("#osiri_submit_idea_content select.property").change(function()
				{
					var id = $(this).parent().parent().attr('id').substring(6);
					
					self.set_value(id, $$(this).val(), OSIRI_NOUVELLE_IDEE_OPTION_KEY_TEXT);
				});

				$("#osiri_upload_idea, #upload_idea").click(function()
				{
					self.upload();
				});

				// $("#upload_idea").click(function()
				// {
				// 	self.upload();
				// });

				$("#osiri_save_idea").click(function()
				{
					self.add();
				});


				$('.my-sheet input').change(function()
				{
					var nmbre = $('#osiri_provenance_list').find("li").length + 1;
					var id = $$(this).attr('id');

					self.set_value_in_data('provenance_'+nmbre+'_'+id, $$(this).val());
				});

				$('.my-sheet select').change(function()
				{
					var nmbre = $('#osiri_provenance_list').find("li").length + 1;
					var id = $$(this).attr('id');
					var element = $$(this).children();

					for ( var i = 0; i<element.length; i++)
					{
						if (element[i].selected == true) 
						{
							return self.set_value_in_data('provenance_'+nmbre+'_'+id, $$(this).val());
						}
					}
				});

				$$('#add_provenance').click(function()
				{
					self.save();
					var nmbre = $('#osiri_provenance_list').find("li").length + 1;
					if ( nmbre <= 3 )
					{
						var a = '<li id="provenance_'+nmbre+'" class="swipeout deleted-callback">'+
							'<div class="item-content swipeout-content">'+
								'<div class="item-inner">'+
									'<div class="item-title-row">'+
										'<div class="item-title">'+ self.data['provenance_'+nmbre+'_nom'] +' '+ self.data['provenance_'+nmbre+'_prenom'] +'</div>'+
										'<div class="item-after">'+ self.data['provenance_'+nmbre+'_metier'] +' '+ self.data['provenance_'+nmbre+'_entite'] +'</div>'+
									'</div>'+
									'<div class="item-subtitle">'+ self.data['provenance_'+nmbre+'_email'] +'</div>'+
								'</div>'+
							'</div>'+
							'<div class="swipeout-actions-right">'+
								'<a href="#" class="swipeout-delete">Supprimer</a>'+
							'</div>'+
						'</li>';

						if (self.data['provenance_'+nmbre+'_nom'] && self.data['provenance_'+nmbre+'_prenom']) 
						{
							$('#osiri_provenance_list').append(a);
						}
						else 
						{
							ws_tools.toast('Veuillez vous ajouter le nom et le prènom du provenance!', 'center');
						}
					}
				})

				$$('.my-sheet').on('sheet:closed', function (e)
				{
					var nmbre = $('#osiri_provenance_list').find("li").length + 1;

					self.data['provenance_'+nmbre+'_nom'] = undefined;
					self.data['provenance_'+nmbre+'_prenom'] = undefined;
					self.data['provenance_'+nmbre+'_metier'] = undefined;
					self.data['provenance_'+nmbre+'_entite'] = undefined;
					self.data['provenance_'+nmbre+'_email'] = undefined;

					var inputs = $('.my-sheet input');
					for ( var i = 0; i<inputs.length; i++)
					{
						inputs[i].value = "";
					}
				});

				$(".smart-select select").change(function(e)
				{
					var nmbre = $('#osiri_provenance_list').find("li").length + 1;
					if ( nmbre<=3 )
					{
						var element = $$(this).children();
						for ( var i = 0; i<element.length; i++)
						{
							if (element[i].selected == true) 
							{
								self.set_value('provenance_'+nmbre+'_nom', $(element[i]).attr('ws_nom'));
								self.set_value('provenance_'+nmbre+'_email', $(element[i]).attr('ws_email'));
								self.set_value('provenance_'+nmbre+'_prenom', $(element[i]).attr('ws_prenom'));
								self.set_value('provenance_'+nmbre+'_metier', $(element[i]).attr('ws_metier'));
								self.set_value('provenance_'+nmbre+'_entite', $(element[i]).attr('ws_entite'));
								break;
							}
						}
						
						var a = '<li id="provenance_'+nmbre+'" class="swipeout deleted-callback">'+
						'<div class="item-content swipeout-content">'+
							'<div class="item-inner">'+
								'<div class="item-title-row">'+
									'<div class="item-title">'+ self.data['provenance_'+nmbre+'_nom'] +' '+ self.data['provenance_'+nmbre+'_prenom'] +'</div>'+
									'<div class="item-after">'+ self.data['provenance_'+nmbre+'_metier'] +' '+ self.data['provenance_'+nmbre+'_entite'] +'</div>'+
								'</div>'+
								'<div class="item-subtitle">'+ self.data['provenance_'+nmbre+'_email'] +'</div>'+
							'</div>'+
						'</div>'+
						'</li>';
						if (self.data['provenance_'+nmbre+'_nom'] && self.data['provenance_'+nmbre+'_prenom'] && self.data['provenance_'+nmbre+'_email']) $('#osiri_provenance_list').append(a);
					}
					
					
				});

				$$('.deleted-callback').on('swipeout:deleted', function ()
				{
					var id = $(this).attr("id");
					
					self.data[id+'_nom'] = undefined;
					self.data[id+'_prenom'] = undefined;
					self.data[id+'_email'] = undefined;
					self.data[id+'_metier'] = undefined;
					self.data[id+'_entite'] = undefined;
					
					return self.save();
				});
			},
			
			set_value_in_data : function(property_id, value, prop_change)
			{
				if (this.data[property_id] == undefined) this.data[property_id] = "";
				
				if (this.data[property_id] != value)
				{
					this.data[property_id] = value;
					
				}
			},

			set_value : function(property_id, value, prop_change)
			{
				if (this.data[property_id] == undefined) this.data[property_id] = "";
				
				if (this.data[property_id] != value)
				{
					this.data[property_id] = value;
					
					return this.is_new ? this.save() : this.save_in_db();
				}
				
				return Promise.resolve();
			},

			add : function()
			{
				var self = this;

				var properties = [
					OSIRI_NOUVELLE_IDEE_PROPERTY_NOM,
					OSIRI_NOUVELLE_IDEE_PROPERTY_DATE,
					OSIRI_NOUVELLE_IDEE_PROPERTY_OBJECTIFS,
					OSIRI_NOUVELLE_IDEE_PROPERTY_PHOTO,
					OSIRI_NOUVELLE_IDEE_PROPERTY_DATA,
					OSIRI_NOUVELLE_IDEE_PROPERTY_SENT,
				];

				var values = [
					self.data[OSIRI_NOUVELLE_IDEE_PROPERTY_NOM] ? self.data[OSIRI_NOUVELLE_IDEE_PROPERTY_NOM] : "",
					ws_tools.get_date_as_string(),
					self.data[OSIRI_NOUVELLE_IDEE_PROPERTY_OBJECTIFS] ? self.data[OSIRI_NOUVELLE_IDEE_PROPERTY_OBJECTIFS] : "",
					self.data[OSIRI_NOUVELLE_IDEE_PROPERTY_PHOTO] ? self.data[OSIRI_NOUVELLE_IDEE_PROPERTY_PHOTO] : "",
					JSON.stringify(self.data),
					false
				];

				return ws_database.nouvelle_idees.add_with_server(ws_engine.get_server_id(), properties,values).then(function(result)
				{
					ws_tools.toast("l'idée est bien enregister !");
					self.id = result;
					return result;
				});
			},

			save : function()
			{
				var self = this;
				
				return Promise.resolve();
			},

			save_in_db : function()
			{
				var self = this;

				var properties = [
					OSIRI_NOUVELLE_IDEE_PROPERTY_NOM,
					OSIRI_NOUVELLE_IDEE_PROPERTY_DATE,
					OSIRI_NOUVELLE_IDEE_PROPERTY_OBJECTIFS,
					OSIRI_NOUVELLE_IDEE_PROPERTY_PHOTO,
					OSIRI_NOUVELLE_IDEE_PROPERTY_DATA,
					OSIRI_NOUVELLE_IDEE_PROPERTY_SENT,
				];

				var values = [
					self.data[OSIRI_NOUVELLE_IDEE_PROPERTY_NOM] ? self.data[OSIRI_NOUVELLE_IDEE_PROPERTY_NOM] : "",
					ws_tools.get_date_as_string(),
					self.data[OSIRI_NOUVELLE_IDEE_PROPERTY_OBJECTIFS] ? self.data[OSIRI_NOUVELLE_IDEE_PROPERTY_OBJECTIFS] : "",
					self.data[OSIRI_NOUVELLE_IDEE_PROPERTY_PHOTO] ? self.data[OSIRI_NOUVELLE_IDEE_PROPERTY_PHOTO] : "",
					JSON.stringify(self.data),
					false
				];
				
				return ws_database.nouvelle_idees.set_with_id(self.id, properties, values);
			},

			upload: function()
			{
				var self = this;

				app.dialog.preloader("Envoi en cours...");
				
				debugger

				ws_server.depose_idee(self.data).then(function(result)
				{
					if (typeof result == 'string') throw result;
					
					app.dialog.close();
					app.dialog.alert("La nouvelle idée a bien été envoyée à OSIRI");
					if (self.id) self.nouvelle_idee_update(self.id, result[OSIRI_NOUVELLE_IDEE_PROPERTY_SERVER_ID]);
					else
					{
						self.add().then(function(result)
						{
							self.nouvelle_idee_update(result, result[OSIRI_NOUVELLE_IDEE_PROPERTY_SERVER_ID]);
						});
					}
					// ws_storage.set_value(OSIRI_STORAGE_KEY_IDEE, JSON.stringify({}));
				})
				.catch(function(error)
				{
					app.dialog.close();
					app.dialog.alert("Error : " + error);
				});
			},

			nouvelle_idee_update: function(id, server_id)
			{
				return ws_database.nouvelle_idees.set_with_id(id, [OSIRI_NOUVELLE_IDEE_PROPERTY_SENT, OSIRI_NOUVELLE_IDEE_PROPERTY_SERVER_ID], [true, server_id]);
			}
		}));
	</script>
</div>
		