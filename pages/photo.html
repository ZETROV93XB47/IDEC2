<div class="page" data-name="photo">

	<div class="navbar">
		<div class="navbar-inner">
			<div class="left">
				<a href="#" class="link back">
					<i class="icon icon-back"></i>
					<span class="ios-only">Back</span>
				</a>
			</div>			
			<div class="title">OP2A Mobile - Photo</div>
			<div class="right">
				<a class="link icon-only" id="op2a_photos_edit">
					<i class="fal fa-edit"></i>
				</a>
			</div>
		</div>
	</div>
	
	<div class="fab fab-left-bottom">
		<a href="#">
			<i class="fal fa-file-alt"></i>
			<i class="fas fa-file-alt"></i>
<!--
			<i class="icon f7-icons">add</i>
			<i class="icon f7-icons">close</i>
-->
		</a>
		<div class="fab-buttons fab-buttons-top">
<!--
			<a id="op2a_add_to_form_button" href="#" class="fab-label-button"><span>4</span><span class="fab-label">Ajouter à un formulaire...</span></a>
			<a id="op2a_add_to_form_button" href="#" class="fab-label-button"><span>3</span><span class="fab-label">Ajouter au formulaire courant</span></a>
-->
			<a id="op2a_new_constat_qse_button" href="#" class="fab-label-button fab-close"><span>Q</span><span class="fab-label">Nouveau constat QSE</span></a>
			<a id="op2a_new_vam_button" href="#" class="fab-label-button fab-close"><span>V</span><span class="fab-label">Nouvelle VAM</span></a>
		</div>
	</div>
	<div class="fab fab-right-bottom"><a id="op2a_photo_save_button" href="#"><i class="icon f7-icons">check</i></a></div>

	<div class="page-content">
		<script id="op2a_photo_template" type="text/template7">
			<div class="ws_app_page_header_block">
				<div class= "ws_app_page_header">{{ nom }}<a id="op2a_photo_rename" href="#" ws_on_click="do_rename"><i class="fa fa-pen" style="font-size:21px; margin-left:15px;"> </i></a></div>
			</div>
			<div class="block" style="text-align:center;">
				<img src="{{ source }}" height="150px">
			</div>
			<div class="block">
				<div class="list">
					<ul>
						<li>
							<a href="#" id="op2a_chantier_selector" class="item-link smart-select smart-select-init" data-searchbar="true" data-searchbar-placeholder="Chercher..." data-virtual-list="true" data-close-on-select="true">
								<div class="item-content">
									<div class="item-inner">
										<div class="item-title">Chantier</div>
										<div class="item-after">{{ chantier_name }}</div>
									</div>
								</div>
								<select id="op2a_chantier_select" name="chantier">
									{{#each chantiers_options}}
									<option value="{{ id }}">{{ nom }}</option>
									{{/each}}
								</select>
							</a>
						</li>			
						<li>
							<a href="#" id="op2a_metier_selector" class="item-link smart-select smart-select-init" data-close-on-select="true">
								<div class="item-content">
									<div class="item-inner">
										<div class="item-title">Métier</div>
										<div class="item-after">{{ metier_name }}</div>
									</div>
								</div>
								<select id="op2a_metier_select" name="metier">
									{{ metiers_options }}
								</select>
							</a>
						</li>			
						<li>
							<a href="#" id="op2a_materiel_selector" class="item-link smart-select smart-select-init" data-close-on-select="true">
								<div class="item-content">
									<div class="item-inner">
										<div class="item-title">Matériel</div>
										<div class="item-after">{{ materiel_name }}</div>
									</div>
								</div>
								<select id="op2a_materiel_select" name="materiel">
									<option value="0">...</option>
									{{#each materiels_options}}
									<option value="{{ id }}">{{ designation }}</option>
									{{/each}}
								</select>
							</a>
						</li>			
						<li>
							<a href="#" id="op2a_operation_selector" class="item-link smart-select smart-select-init" data-close-on-select="true">
								<div class="item-content">
									<div class="item-inner">
										<div class="item-title">Opération</div>
										<div class="item-after">{{ operation_name }}</div>
									</div>
								</div>
								<select id="op2a_operation_select" name="operation">
									<option value="montage">Montage</option>
									{{#each operations_options}}
									<option value="{{ id }}">{{ name }}</option>
									{{/each}}
									<option value="demontage">Demontage</option>
								</select>
							</a>
						</li>			
					</ul>
				</div>
			</div>
			<div class="block">
				<div class="block-title">
					<div>Commentaire</div>
				</div>
				<p class="row">
					<textarea id='op2a_photo_comment_text_area' class="col resizable" name="commentaire" style="width:100%; border:solid 1px gray; padding:4px;" rows="6">{{ commentaire }}</textarea>
				</p>
			</div>
			{{/if}}
			<div class="block">
				<p class="row">
					<button class="button button-fill button-big color-red" id="op2a_photo_delete" >Supprimer</button>
				</p>
			</div>
		</script>
		
		<div id="op2a_photo_content">
		</div>
	</div>
	
	<script type="text/javascript" ws_script="page">
	ws_engine.register_page("photo", ws_page.extend(
	{	
		custom_init: function(page, event, params)
		{
			var self = this;
			
			self.photo_id = self.params.id;
			self.photo = undefined;
			
			self.chantier_id = undefined;
			self.metier = undefined;
			self.materiel_id = undefined;
			self.operation_id = undefined;
			
			self.template_data = {};
			
			self.get_element_with_selector('.fab.fab-right-bottom').hide();
			
			return self.get_template_data().then(function()
			{
				return self.load_page();
			});
		},
		
		load_page: function()
		{
			var self = this;
			
			return self.apply_template(page, "op2a_photo_template", "op2a_photo_content", self.template_data).then(function()
			{
				self.update_links();
				
				$$("#op2a_chantier_selector").click(function()
				{
					self.template_data.materiels_options = {};
					self.template_data.operations_options = {};
					self.template_data.materiel_name = "";
					self.template_data.operation_name = "";
					return self.load_page();
				});
				
				$$("#op2a_metier_selector").click(function()
				{
					self.template_data.materiels_options = {};
					self.template_data.operations_options = {};
					self.template_data.materiel_name = "";
					self.template_data.operation_name = "";
					return self.load_page();
				});
				
				$$("#op2a_materiel_selector").click(function()
				{
					self.template_data.operations_options = {};
					self.template_data.operation_name = "";
					return self.load_page();
				});
				
				$$("#op2a_chantier_select").change(function()
				{
					var element = $$(this).children();
					for(var i = 0; i<element.length; i++)
					{
						if (element[i].selected == true) 
						{
							self.chantier_id = element[i].value;
							self.template_data.chantier_name = element[i].text;
							self.template_data.materiels_options = {};
							self.template_data.operations_options = {};
							
							return self.load_page();
						}
					}
				});
				
				$$("#op2a_metier_select").change(function()
				{
					var element = $$(this).children();
					for(var i = 0; i<element.length; i++)
					{
						if (element[i].selected == true) 
						{
							self.metier = element[i].value;
							
							if (self.metier == "Tous")
							{
								self.template_data.metier_name = self.metier;
								return ws_database.materiels.find("chantier_id = ?", [self.chantier_id]).then(function(db_materiels)
								{
									self.template_data.materiels_options = db_materiels;
									self.template_data.operations_options = {};
									self.materiel_id = undefined;
									self.operation_id = undefined;
									
									return self.load_page();
								});
							}
							else 
							{
								self.template_data.metier_name = self.metier;
								return ws_database.materiels.find("chantier_id = ? AND metier = ?", [self.chantier_id, self.metier]).then(function(db_materiels)
								{
									self.template_data.materiels_options = db_materiels;
									self.template_data.operations_options = {};
									self.materiel_id = undefined;
									self.operation_id = undefined;
									
									return self.load_page();
								});
							}
							
						}
					}
				});
				
				$$("#op2a_materiel_select").change(function()
				{
					var element = $$(this).children();
					for(var i = 0; i<element.length; i++)
					{
						if (element[i].selected == true) 
						{
							self.materiel_id = element[i].value;
							self.template_data.materiel_name = element[i].text;
						
							return ws_database.operations.find("chantier_id = ? AND materiel_id = ?", [self.chantier_id, self.materiel_id]).then(function(db_operations)
							{
								self.template_data.operations_options = db_operations;
								self.operation_id = undefined;
								
								return self.load_page();
							});
						}
					}
				});
				
				$$("#op2a_operation_select").change(function()
				{
					var element = $$(this).children();
					for(var i = 0; i<element.length; i++)
					{
						if (element[i].selected == true) 
						{
							self.operation_id = element[i].value;
							self.template_data.operation_name = element[i].text;
							
							return self.load_page();
						}
					}
				});
				
				$("#op2a_photo_comment_text_area").off('keydown');
				$("#op2a_photo_save_button").off('click');
				$$("#op2a_photo_rename").off('click');
				$("#op2a_photos_edit").off('click');
				$("#op2a_photo_delete").off('click');
				
				
				$("#op2a_photo_comment_text_area").on('keydown',function()
				{
					self.on_comment_change();
				});
				$("#op2a_photo_save_button").on('click',function()
				{
					self.on_save_comment();
				});
				
				$$("#op2a_photo_rename").on('click',function()
				{
					return self.do_rename();
				});
				
				$("#op2a_photos_edit").on('click',function()
				{
					page.view.router.navigate("/photo_edit/"+self.photo_id);
				});
				
				$("#op2a_photo_delete").on('click',function()
				{
					self.do_delete();
				});
			});
			
		},
		
		get_template_data: function()
		{
			var self = this;
			
			return ws_database.files.get_with_id(self.photo_id).then(function(photo_db)
			{
				self.photo = photo_db;
				
				self.template_data.id = self.photo_id;
				self.template_data.nom = photo_db[WS_FILE_PROPERTY_NAME];
				self.template_data.commentaire = photo_db[OP2A_FILE_PROPERTY_COMMENT];
				
				self.chantier_id = self.photo[OP2A_FILE_PROPERTY_CHANTIER_ID];
				self.metier = self.photo[OP2A_FILE_PROPERTY_METIER_REF];
				self.materiel_id = self.photo[OP2A_FILE_PROPERTY_MATERIEL_ID];
				self.operation_id = self.photo[OP2A_FILE_PROPERTY_OPERATION_ID];
				
				return op2a_photos.get_photo_as_data_url(photo_db[WS_FILE_PROPERTY_PATH])
			})
			.then(function(data_url)
			{
				self.template_data.source = data_url;
				
				return ws_database.chantiers.all();
			})
			.then(function(db_chantier)
			{
				self.template_data.chantiers_options = db_chantier;
				
				return op2a_chantiers.get_metiers_as_select_options(undefined, "Tous métiers");
			})
			.then(function(metier)
			{
				self.template_data.metiers_options = metier;
				return self.init_inputs();
			});
		},
		
		update_links: function()
		{
			var self = this;
			
			if(self.chantier_id)
			{
				self.get_element('op2a_new_constat_qse_button').attr('href', "/formulaire_constat_qse_new/"+self.chantier_id+"/metier/"+self.metier+"/photo/"+self.photo_id);
				self.get_element('op2a_new_vam_button').attr('href', "/formulaire_vam_operation_selector/"+self.chantier_id+"/metier/"+self.metier+"/materiel/"+self.materiel_id+"/operation/"+self.operation_id+"/photo/"+self.photo_id);
			}
			else
			{
				self.get_element('op2a_new_constat_qse_button').attr('href', "/formulaire_constat_qse_new/"+ self.photo_id);
				self.get_element('op2a_new_vam_button').attr('href', "/formulaire_vam_operation_selector/");
			}
		},
		
		on_comment_change: function()
		{
			$('.fab.fab-right-bottom').show();
		},
		
		on_comment_focus_in: function(self, chantier, metier, materiel, operation)
		{
			self.get_element_with_selector('.fab.fab-right-bottom').show();
		},
		
		on_comment_focus_out: function(self, chantier, metier, materiel, operation)
		{
			self.get_element_with_selector('.fab.fab-right-bottom').hide();
		},
		
		on_save_comment: function()
		{
			var self = this;
			
			var properties = [
				OP2A_FILE_PROPERTY_CHANTIER_ID,
				OP2A_FILE_PROPERTY_METIER_REF,
				OP2A_FILE_PROPERTY_MATERIEL_ID,
				OP2A_FILE_PROPERTY_OPERATION_ID,
				OP2A_FILE_PROPERTY_COMMENT,
			];
			var values = [
				self.chantier_id,
				self.metier,
				self.materiel_id,
				self.operation_id,
				$('#op2a_photo_comment_text_area').val(),
			];
			
			ws_database.files.set_with_id(self.params.id, properties, values).then(function()
			{
				self.get_element_with_selector('.fab.fab-right-bottom').hide();
			});
		},
									

		init_inputs: function()
		{
			var self = this;
			
			if (self.chantier_id)
			{
				return ws_database.chantiers.get_with_id(self.chantier_id).then(function(db_chantier)
				{
					self.template_data.chantier_name = db_chantier.nom;
					
					if(self.metier) 
					{
						self.template_data.metier_name = self.metier;
						
						if(self.materiel_id && self.materiel_id != "undefined") 
						{
							return ws_database.materiels.get_with_id(self.materiel_id).then(function(db_materiel)
							{
								self.template_data.materiel_name = db_materiel.designation;
								
								if (self.metier == "Tous")
								{
									self.template_data.metier_name = self.metier;
									return ws_database.materiels.find("chantier_id = ?", [self.chantier_id]).then(function(db_materiels)
									{
										self.template_data.materiels_options = db_materiels;
										
									});
								}
								else 
								{
									self.template_data.metier_name = self.metier;
									return ws_database.materiels.find("chantier_id = ? AND metier = ?", [self.chantier_id, self.metier]).then(function(db_materiels)
									{
										self.template_data.materiels_options = db_materiels;
										
									});
								}
							})
							.then(function()
							{
								if(self.operation_id && self.operation_id != "undefined")
								{
									if (typeof self.operation_id == "number") return ws_database.operations.find("chantier_id = ? AND materiel_id = ? AND id = ?", [self.chantier_id, self.materiel_id, self.operation_id]).then(function(db_operation)
									{
										self.template_data.operation_name = db_operation[0].name;
									});
									else self.template_data.operation_name = self.operation_id;
								}
								
								
							});
						}
						
					}
				});
			}
		},
		
		do_rename: function()
		{
			var self = this;
			
			ws_database.files.get_with_id(self.params.id).then(function(photo_db)
			{
				var apply = function(value)
				{
					if (value.length > 0) ws_database.files.set_with_id(self.params.id, [WS_FILE_PROPERTY_NAME], [value]).then(function()
					{
						return self.get_template_data().then(function()
						{
							return self.load_page();
						});
					});
				}
				
				app.dialog.prompt("Indiquez le nouveau nom :", "Renommer", apply, null, photo_db[WS_FILE_PROPERTY_NAME]);
			});
		},
		
		do_delete: function()
		{
			var self = this;
			
			var apply = function(value)
			{
				op2a_photos.delete_photo(self.params.id).then(function()
				{
					page.view.router.back();
				});
			}

			app.dialog.confirm("Supprimer la photo ?", "Supprimer", apply);
		},

	}));
	</script>
</div>
