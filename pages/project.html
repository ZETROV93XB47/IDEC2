<div class="page" data-name="project">
	<div class="navbar">
		<div class="navbar-bg"></div>
		<div class="navbar-inner sliding">
            <div class="left">
                <a href="#" class="link back">
                <i class="icon icon-back"></i>
                <span class="if-not-md">Back</span>
                </a>
            </div>
			<div class="title">OSIRI - <span id="project-title"></span></div>
		</div>
	</div>
	<div class="toolbar tabbar toolbar-top-md">
		<div class="toolbar-inner">
			<a href="#tab_infos" class="tab-link tab-link-active"><i class="fal fa-info"></i></a>
			<a href="#tab_cdc" class="tab-link"><span class="tabbar-label" style="text-transform:none; font-size: 15px;">CDC</span></a>
			<a href="#tab_interlocuteurs" class="tab-link"><i class="fal fa-user-friends"></i></a>
			<a href="#tab_documents" class="tab-link"><i class="fal fa-file"></i></a>
			<a href="#tab_rexs" class="tab-link"><span class="tabbar-label" style="text-transform:none; font-size: 15px;">REX</span></a>
		</div>
	</div>
	<div class="page-content">
		<div class="tabs-swipeable-wrap hide-navbar-on-scroll" style="padding-bottom: 60px;">
			<div class="tabs">
				<div class="page-content tab tab-active" id="tab_infos" style="padding-top: 20px;">
					<div id="osiri_infos_templete_content">
					</div>
				</div>

				<div class="page-content tab" id="tab_cdc" style="padding-top: 0px;">
					<div id="osiri_cdc_templete_content">
					</div>
				</div>

				<div class="page-content tab" id="tab_interlocuteurs" style="padding-top: 0px;">
					<div id="osiri_interlocuteurs_templete_content">
					</div>
				</div>

				<div class="page-content tab" id="tab_documents" style="padding-top: 0px;">
					<div id="osiri_documents_templete_content">
					</div>
				</div>

				<div class="page-content tab" id="tab_rexs" style="padding-top: 0px;">
					<div id="osiri_rexs_templete_content">
					</div>
				</div>
			</div>
		</div>
		<script id="osiri_infos_templete_script" type="text/template7">
			<div class="osiri_project_img" style="text-align: center;">
				<img data-swiper-parallax="-325" src="{{ image }}" height="280" style="padding-top: 20px;">
			</div>
			<div class="osiriç_project_description">
				<div class="block block-strong" style="margin-top: 0px; margin-bottom: 0px;">
					<div class="list inline-labels no-hairlines" style="margin-top: 0px; margin-bottom: 0px;">
						<ul>
							<li class="item-input">
								<div class="item-inner">
									<div class="item-title" style="font-size: 25px; white-space: normal; text-align: center;">{{ nom }}</div>
								</div>
							</li>
						</ul>
					</div>
				</div>
				<div class="block-header" style="font-size: 20px; margin-top: 0px;">PHASE {{ phase }}</div>	
				<div class="card-content card-content-padding" id="op2a_chantier_infos">
					<div class="list">
						<ul>
							<li>
								<div class="item-content">
									<div class="item-inner">
									<div class="item-title">Pilote</div>
									<div class="item-after">{{ pilote }}</div>
									</div>
								</div>
							</li>
							<li>
								<div class="item-content">
									<div class="item-inner">
									<div class="item-title">Numéro</div>
									<div class="item-after">{{ numero }}</div>
									</div>
								</div>
							</li>
							<li>
								<div class="item-content">
									<div class="item-inner">
									<div class="item-title">Durée phase</div>
									<div class="item-after">{{ date_debut }}</div>
									</div>
								</div>
							</li>
							<li>
								<div class="item-content">
									<div class="item-inner">
									<div class="item-title">Durée projet</div>
									<div class="item-after">{{ date_debut }}</div>
									</div>
								</div>
							</li>
						</ul>
					</div>
				</div>
			</div>
		</script>
		<script id="osiri_cdc_templete_script" type="text/template7">

			<div class="block-title block-title-medium">Cahier des charges</div>

			<div class="block-header">Fonctionnalités</div>
			<div class="block">
				<p>
					{{ fonctionalites }}
				</p>
			</div>

			<div class="block-header">Caractéristiques</div>
			<div class="block">
				<p>
					{{ caracteristiques }}
				</p>
			</div>

			<div class="block-header">Produit existant</div>
			<div class="block">
				<p>
					{{ categorie }}
				</p>
			</div>

			<div class="block-header">Étude de marché</div>
			<div class="block">
				<p>
					{{ test }}
				</p>
			</div>

			<div class="block-header">Secteur d'activité</div>
			<div class="block">
				<p>
					{{ test }}
				</p>
			</div>
			<!-- <div class="block block-strong">
				<div class="block-title block-title-medium">Cahier des charges</div>

				<div class="block-header" style="font-size: 18px;">Fonctionnalités</div>
				<div type="text" class="title" style="font-size: 15px;">{{ fonctionalites }}</div>

				<div class="block-header" style="font-size: 18px;">Caractéristiques</div>
				<div type="text" class="title" style="font-size: 15px;">{{ caracteristiques }}</div>
				
				<div class="block-header" style="font-size: 18px;">Produit existant</div>
				<div type="text" class="title" style="font-size: 15px;">{{ categorie }}</div>
				
				<div class="block-header" style="font-size: 18px;">Étude de marché</div>
				<div type="text" class="title" style="font-size: 15px;">{{ test }}</div>

				<div class="block-header" style="font-size: 18px;">Secteur d'activité</div>
				<div type="text" class="title" style="font-size: 15px;">{{ test }}</div>
			</div> -->
		</script>

		<script id="osiri_interlocuteurs_templete_script" type="text/template7">
			
			<div class="block-title block-title-medium">Interlocuteurs étude</div>
			<div class="card-content card-content-padding" id="op2a_chantier_infos">
				<div class="list">
					<ul>
						{{#each interlocuteurs_etude}}
						<li>
							<div class="item-content">
								<div class="item-inner">
								<div class="item-title" style="white-space: normal;">{{#if leader}}<i class="fas fa-user-tie"></i>{{else}}<i class="fas fa-user"></i>{{/if}} {{ name }}</div>
								<div class="item-after">{{ metier }}</div>
								</div>
							</div>
						</li>
						{{/each}}
					</ul>
				</div>
			</div>
			<!-- {{#each interlocuteurs_etude}}
			<div type="text" class="title" style="font-size: 15px;">{{#if leader}}<i class="fas fa-user-tie"></i>{{else}}<i class="fas fa-user"></i>{{/if}} {{ name }} - {{ metier }}</div>
			{{/each}} -->
			
			<div class="block block-strong">
				<div class="block-title block-title-medium">Pilotes</div>
				<div type="text" class="title" style="font-size: 15px;"><i class="fas fa-user"></i> {{ pilote }}</div>
			</div>
			
			<div class="block-title block-title-medium">Interlocuteurs REX</div>
			<div class="card-content card-content-padding" id="op2a_chantier_infos">
				<div class="list">
					<ul>
						{{#each interlocuteurs_rex}}
						<li>
							<div class="item-content">
								<div class="item-inner">
								<div class="item-title" style="white-space: normal;"><i class="fas fa-user"></i> {{ interlocuteur_rex_name }}</div>
								</div>
							</div>
						</li>
						{{/each}}
					</ul>
				</div>
			</div>
			<!-- {{#each interlocuteurs_rex}}
			<div type="text" class="title" style="font-size: 15px;">{{ name }} - {{ metier }}</div>
			{{/each}} -->
		</script>

		<script id="osiri_documents_templete_script" type="text/template7">
			<div class="block-title block-title-medium">Documents</div>
			<div class="card-content card-content-padding" id="op2a_chantier_infos">
				<div class="list">
					<ul>
						{{#each documents_list}}
						<li>
							<a  class="item-content item-link external" href="{{ url }}">
								<div class="item-inner">
									<div class="item-title" style="white-space: normal;">{{ name }}</div>
									<div class="item-after">{{ type }}</div>
								</div>
							</a>
						</li>
						{{/each}}
					</ul>
				</div>
			</div>
		</script>

		<script id="osiri_rexs_templete_script" type="text/template7">
			<div class="block-title block-title-medium">Chantiers</div>
			<div class="list accordion-list">
				<ul>
					{{#each phase_chantiers}}
					<li class="accordion-item">
						<a href="#" class="item-content item-link" style="background-color: #e6e6e6;">
							<div class="item-inner">
							<div class="item-title">{{ chantier }}</div>
							</div>
						</a>
						<div class="accordion-item-content">
							<div class="card-content card-content-padding" id="op2a_chantier_infos">
								<div class="list">
									<ul>
										<li>
											<div class="item-content">
												<div class="item-inner">
												<div class="item-title">Interlocuteur REX</div>
												<div class="item-after">{{ interlocuteur_rex_name }}</div>
												</div>
											</div>
										</li>
										<li>
											<div class="item-content">
												<div class="item-inner">
												<div class="item-title">Début et fin des tests</div>
												<div class="item-after">{{ date_debut }} - {{ date_fin }}</div>
												</div>
											</div>
										</li>
										<li>
											<div class="item-content">
												<div class="item-inner">
												<div class="item-title">Date rex previsionnelle</div>
												<div class="item-after">{{ date_rex_previsionnelle }}</div>
												</div>
											</div>
										</li>
										<li>
											<div class="item-content">
												<div class="item-inner">
												<div class="item-title">Quantité</div>
												<div class="item-after">{{ quantite }}</div>
												</div>
											</div>
										</li>
										<li>
											<div class="item-content">
												<div class="item-inner">
												<div class="item-title">Commentaire</div>
												<div class="item-after">{{ comment }}</div>
												</div>
											</div>
										</li>
									</ul>
								</div>
							</div>
						</div>
					</li>
					{{/each}}
				</ul>
			</div>
		</script>

		<script id="osiri_project_template" type="text/template7">
			<!-- <div class="osiri_project_img" style="text-align: center;">
				<img data-swiper-parallax="-325" src="./img/projet_img.png" height="150" style="padding-top: 20px;">
			</div>
			<div class="osiriç_project_description">
				<div class="block block-strong" style="margin-top: 0px;">
					<div class="list inline-labels no-hairlines" style="margin-top: 0px; margin-bottom: 0px;">
						<ul>
							<li class="item-input">
								<div class="item-inner">
									<div class="item-title" data-swiper-parallax="-300" style="font-size: 25px; white-space: normal; text-align: center;">{{ nom }}</div>
								</div>
							</li>
							<li>
								<div class="item-subtitle" data-swiper-parallax="-275" style="font-size: 15px;">Catégorie : {{ categorie }}</div>
								<div class="item-subtitle" data-swiper-parallax="-275" style="font-size: 15px;">Date debut : {{ date_debut }}</div>
							</li>
						</ul>
					</div>
				</div>
				<div class="block block-strong">
					<div class="block-header" data-swiper-parallax="-250">fonctionalites</div>
					<div type="text" class="title" data-swiper-parallax="-250" style="font-size: 15px; text-align: justify;">{{ fonctionalites }}</div>
				</div>
			</div> -->
		</script>
		
		<div id="osiri_project_content"></div>
	</div>
	<script type="text/javascript" ws_script="page">
		ws_engine.register_page("project", ws_page.extend(
		{	
			custom_init: function(page, event, params)
			{
                var self = this;
                
				self.id = params.id;
			    self.data = {};

				return self.load_page();
			},
			
			load_page: function()
			{
				this.get_template_data().then((result) =>
				{
					this.apply_template(page, "osiri_infos_templete_script", "osiri_infos_templete_content", this.data);
					this.apply_template(page, "osiri_cdc_templete_script", "osiri_cdc_templete_content", this.data);
					this.apply_template(page, "osiri_interlocuteurs_templete_script", "osiri_interlocuteurs_templete_content", this.data);
					this.apply_template(page, "osiri_documents_templete_script", "osiri_documents_templete_content", this.data);
					this.apply_template(page, "osiri_rexs_templete_script", "osiri_rexs_templete_content", this.data);
				});
			},

			/*load_page: function()
			{
				var self = this;
				
				self.get_template_data().then(function()
				{
					self.apply_template(page, "osiri_infos_templete_script", "osiri_infos_templete_content", self.data);
					self.apply_template(page, "osiri_cdc_templete_script", "osiri_cdc_templete_content", self.data);
					self.apply_template(page, "osiri_interlocuteurs_templete_script", "osiri_interlocuteurs_templete_content", self.data);
					self.apply_template(page, "osiri_documents_templete_script", "osiri_documents_templete_content", self.data);
					self.apply_template(page, "osiri_rexs_templete_script", "osiri_rexs_templete_content", self.data);
				});
			},*/

			get_template_data: async function()
			{
				this.data = await ws_database.projets.get_with_id(this.id);
				
				if (this.data[OSIRI_PROJET_PROPERTY_IMAGE_URL] && !this.data[OSIRI_PROJET_PROPERTY_IMAGE_DOWNLOADED])
				{
					app.dialog.preloader('Chargement de l\'image du projet ...');
					let result = await ws_server.get(this.data[OSIRI_PROJET_PROPERTY_IMAGE_URL]);
                    app.dialog.close();
					if (result.length > 0 && result.substr(0, 10) == 'data:image')
					{
						this.data[OSIRI_PROJET_PROPERTY_IMAGE] = result;
						await ws_database.projets.set_with_id(this.id, [OSIRI_PROJET_PROPERTY_IMAGE, OSIRI_PROJET_PROPERTY_IMAGE_DOWNLOADED], [result, true]);
					}
					else app.dialog.alert('l\'image non récupérer');
				}

				if (!this.data[OSIRI_PROJET_PROPERTY_IMAGE])
				{
					this.data[OSIRI_PROJET_PROPERTY_IMAGE] = './img/projet_img.png';
				}
					

				$('#project-title').text(this.data.nom);
				// interlocuteurs_etude

				this.data.interlocuteurs_etude = await ws_database.interlocuteurs_etude.find(OSIRI_INTERLOCUTEUR_ETUDE_PROPERTY_PROJET + ' = ?', [this.id]);
				for (var i = 0; i<this.data.interlocuteurs_etude.length; i++)
				{
					if (this.data.interlocuteurs_etude[i][OSIRI_INTERLOCUTEUR_ETUDE_PROPERTY_LEADER] == "true") this.data.interlocuteurs_etude[i][OSIRI_INTERLOCUTEUR_ETUDE_PROPERTY_LEADER] = true;
					if (this.data.interlocuteurs_etude[i][OSIRI_INTERLOCUTEUR_ETUDE_PROPERTY_LEADER] == "false") this.data.interlocuteurs_etude[i][OSIRI_INTERLOCUTEUR_ETUDE_PROPERTY_LEADER] = false;
				}

				// this.data.interlocuteurs_rex = await ws_database.interlocuteurs_rex.find(OSIRI_INTERLOCUTEUR_REX_PROPERTY_PROJET + ' = ?', [this.id]);
				
				// documents_list
				
				this.data.documents_list = await ws_database.documents_list.find(OSIRI_DOCUMENT_LIST_PROPERTY_PROJET + ' = ?', [this.id]);
				
				var phase_chantiers = await ws_database.phase_chantiers.find(OSIRI_PHASE_CHANTIER_PROPERTY_PROJET + ' = ?', [this.id]);

				// interlocuteurs_rex

				this.data.interlocuteurs_rex = phase_chantiers;

				// phase chantiers
				
				for (var i = 0; i<phase_chantiers.length; i++)
				{
					var phase_chantier = phase_chantiers[i];
					var chantier = await ws_database.chantiers.get_with_id(phase_chantier.chantier);
					var rex = await ws_database.rexs.get_with_id(phase_chantier.rex);
					

					if (phase_chantier[OSIRI_REX_PROPERTY_DATE_DEBUT]) phase_chantier[OSIRI_REX_PROPERTY_DATE_DEBUT] = ws_tools.get_date_as_string(phase_chantier[OSIRI_PHASE_CHANTIER_PROPERTY_DATE_DEBUT]);
					else phase_chantier[OSIRI_REX_PROPERTY_DATE_DEBUT] = '';
					if (phase_chantier[OSIRI_REX_PROPERTY_DATE_FIN]) phase_chantier[OSIRI_REX_PROPERTY_DATE_FIN] = ws_tools.get_date_as_string(phase_chantier[OSIRI_PHASE_CHANTIER_PROPERTY_DATE_FIN]);
					else phase_chantier[OSIRI_REX_PROPERTY_DATE_FIN] = '';
					if (phase_chantier[OSIRI_PHASE_CHANTIER_PROPERTY_DATE_REX_PREVISIONNELLE]) phase_chantier[OSIRI_PHASE_CHANTIER_PROPERTY_DATE_REX_PREVISIONNELLE] = ws_tools.get_date_as_string(phase_chantier[OSIRI_PHASE_CHANTIER_PROPERTY_DATE_REX_PREVISIONNELLE]);
					else phase_chantier[OSIRI_PHASE_CHANTIER_PROPERTY_DATE_REX_PREVISIONNELLE] = '';

					if (chantier) phase_chantier.chantier = chantier.nom;
				}

				this.data.phase_chantiers = phase_chantiers;
				
				var name = await osiri_projects.get_collaborateur(this.data[OSIRI_PROJET_PROPERTY_PILOTE]);
				
				this.data[OSIRI_PROJET_PROPERTY_DATE_DEBUT] = ws_tools.get_date_as_string(this.data[OSIRI_PROJET_PROPERTY_DATE_DEBUT]);
				this.data[OSIRI_PROJET_PROPERTY_PHASE] = osiri_actions.get_phase_as_string_ma(this.data[OSIRI_PROJET_PROPERTY_PHASE]);
				if (name) return this.data[OSIRI_PROJET_PROPERTY_PILOTE] = name;
				
				var name = await osiri_projects.get_collaborateur(this.data[OSIRI_PROJET_PROPERTY_PILOTE])
				this.data[OSIRI_PROJET_PROPERTY_PILOTE] = name;
			},

			/*get_template_data: function()
			{
				var self = this;

				return ws_database.projets.get_with_id(self.id).then(function(result)
                {
					self.data = result;
					return osiri_projects.get_collaborateur(result[OSIRI_PROJET_PROPERTY_PILOTE]).then(function(name)
					{
						self.data[OSIRI_PROJET_PROPERTY_DATE_DEBUT] = ws_tools.get_date_as_string(self.data[OSIRI_PROJET_PROPERTY_DATE_DEBUT]);
						self.data[OSIRI_PROJET_PROPERTY_PHASE] = osiri_actions.get_phase_as_string_ma(self.data[OSIRI_PROJET_PROPERTY_PHASE]);

						if( name == undefined) return osiri_projects.get_collaborateur(self.data[OSIRI_PROJET_PROPERTY_PILOTE]).then(function(name)
						{
							self.data[OSIRI_PROJET_PROPERTY_PILOTE] = name;
						});
						self.data[OSIRI_PROJET_PROPERTY_PILOTE] = name;
					});
				});
			}*/
			
		}));
	</script>
</div>
